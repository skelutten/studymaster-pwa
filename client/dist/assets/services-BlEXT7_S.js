import{e,a as t,r,d as a}from"./anki-services-DlKSjqeH.js";import{R as n,j as o}from"./react-vendor-D7Istm-s.js";import{ab as s}from"./vendor-DojJshIj.js";class i{config;errors=[];sessionId;initialized=!1;constructor(e={}){this.config={maxStoredErrors:100,enableConsoleLogging:!0,enableLocalStorage:!0,environment:"production",...e},this.sessionId=this.generateSessionId(),this.loadStoredErrors(),this.setupGlobalErrorHandlers(),this.initialized=!0,this.logInfo("Error tracking initialized",{sessionId:this.sessionId})}logError(e,t){const r=this.createErrorReport("error",e,t);this.recordError(r)}logWarning(e,t){const r=this.createErrorReport("warning",e,t);this.recordError(r)}logInfo(e,t){const r=this.createErrorReport("info",e,t);this.recordError(r)}getErrors(){return[...this.errors]}clearErrors(){this.errors=[],this.config.enableLocalStorage&&localStorage.removeItem("studymaster_errors")}getErrorStats(){const e=Date.now()-36e5,t={total:this.errors.length,byLevel:{error:0,warning:0,info:0},recent:0};return this.errors.forEach(r=>{t.byLevel[r.level]++,new Date(r.timestamp).getTime()>e&&t.recent++}),t}exportErrors(){return JSON.stringify(this.errors,null,2)}createErrorReport(e,t,r){const a=t instanceof Error?t.message:t,n=t instanceof Error?t.stack:void 0;return{id:this.generateErrorId(),timestamp:(new Date).toISOString(),level:e,message:a,stack:n,userAgent:navigator.userAgent,url:window.location.href,sessionId:this.sessionId,context:r||{}}}recordError(e){if(this.errors.unshift(e),this.errors.length>this.config.maxStoredErrors&&(this.errors=this.errors.slice(0,this.config.maxStoredErrors)),this.config.enableConsoleLogging){("error"===e.level?console.error:"warning"===e.level?console.warn:console.log)(`[ErrorTracker] ${e.message}`,e)}if(this.config.enableLocalStorage)try{localStorage.setItem("studymaster_errors",JSON.stringify(this.errors.slice(0,50)))}catch(t){this.errors=this.errors.slice(0,25);try{localStorage.setItem("studymaster_errors",JSON.stringify(this.errors))}catch(r){console.warn("Error tracking: Local storage disabled due to quota issues")}}this.config.apiEndpoint&&"production"===this.config.environment&&this.sendToRemote(e).catch(e=>{console.warn("Failed to send error to remote endpoint:",e)})}loadStoredErrors(){if(this.config.enableLocalStorage)try{const e=localStorage.getItem("studymaster_errors");if(e){const t=JSON.parse(e);Array.isArray(t)&&(this.errors=t)}}catch(e){console.warn("Failed to load stored errors:",e)}}setupGlobalErrorHandlers(){if(window.addEventListener("error",e=>{this.logError(e.error||new Error(e.message),{filename:e.filename,lineno:e.lineno,colno:e.colno,type:"unhandled_error"})}),window.addEventListener("unhandledrejection",e=>{this.logError(new Error(`Unhandled promise rejection: ${e.reason}`),{type:"unhandled_promise_rejection",reason:e.reason})}),window.React){const e=window.console.error;window.console.error=(...t)=>{const r=t[0];"string"==typeof r&&r.includes("React")&&this.logError(new Error(r),{type:"react_error",args:t}),e.apply(console,t)}}}async sendToRemote(e){if(this.config.apiEndpoint)try{await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.config.apiKey?{Authorization:`Bearer ${this.config.apiKey}`}:{}},body:JSON.stringify({...e,environment:this.config.environment,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})})}catch(t){console.warn("Failed to send error to remote endpoint:",t)}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateErrorId(){return`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}const c=new i({environment:"production",maxStoredErrors:100,enableConsoleLogging:!1,enableLocalStorage:!0}),logError=(e,t)=>c.logError(e,t),logWarning=(e,t)=>c.logWarning(e,t),logInfo=(e,t)=>c.logInfo(e,t);n.Component;function hasSubtleCrypto(){try{return"undefined"!=typeof crypto&&!!crypto.subtle?.digest}catch{return!1}}function toBase64Url(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return("undefined"!=typeof btoa?btoa(t):Buffer.from(e).toString("base64")).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function deriveAnonymizedId(e,t){const r=(new TextEncoder).encode(`${e}:${t}`);if(hasSubtleCrypto())try{const e=await crypto.subtle.digest("SHA-256",r);return toBase64Url(new Uint8Array(e))}catch{}return toBase64Url(r)}function uuidv4(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}async function createLocalProfileInternal(r,a){await e();const n=uuidv4(),o=Date.now(),s=await deriveAnonymizedId(n,o),i={deviceUserId:n,displayName:r,avatarUrl:a,anonymizedId:s,createdAt:o,updatedAt:o};return await t.users.add(i),{deviceUserId:i.deviceUserId,displayName:i.displayName,avatarUrl:i.avatarUrl,anonymizedId:i.anonymizedId||s,createdAt:i.createdAt,updatedAt:i.updatedAt}}async function getLocalProfile(){await e();const r=await t.users.toCollection().first();return r?{deviceUserId:r.deviceUserId,displayName:r.displayName,avatarUrl:r.avatarUrl,anonymizedId:r.anonymizedId||await deriveAnonymizedId(r.deviceUserId,r.createdAt),createdAt:r.createdAt,updatedAt:r.updatedAt}:null}async function ensureLocalProfile(e,t){const r=await getLocalProfile();return r||createLocalProfileInternal(e,t)}async function updateLocalProfile(r){await e();const a=await t.users.toCollection().first();if(!a)return createLocalProfileInternal(r.displayName,r.avatarUrl);const n={...a,displayName:r.displayName??a.displayName,avatarUrl:r.avatarUrl??a.avatarUrl,updatedAt:Date.now()};return await t.users.put(n),{deviceUserId:n.deviceUserId,displayName:n.displayName,avatarUrl:n.avatarUrl,anonymizedId:n.anonymizedId||await deriveAnonymizedId(n.deviceUserId,n.createdAt),createdAt:n.createdAt,updatedAt:n.updatedAt}}function toLinkKey(e,t){return`${e}:${t}`}async function linkAccount(e){return await r.userOnlineLinks.upsert({deviceUserId:e.deviceUserId,provider:e.provider,serverUserId:e.serverUserId,accessToken:e.accessToken,refreshToken:e.refreshToken,scopes:e.scopes,meta:e.meta,lastLinkedAt:e.lastLinkedAt})}async function unlinkAccount(e,t){const a=toLinkKey(e,t);await r.userOnlineLinks.remove(a)}async function getLink(e,t){const a=toLinkKey(e,t);return r.userOnlineLinks.get(a)}async function isLinked(e,t){const r=await getLink(e,t);return!!r?.accessToken&&!!r?.serverUserId}function bytesToHex(e){const t=new Uint8Array(e);let r="";for(let a=0;a<t.length;a++){r+=t[a].toString(16).padStart(2,"0")}return r}async function hashArrayBufferSHA256(e){const t=globalThis.crypto;if(!t?.subtle?.digest)throw new Error("WebCrypto SubtleCrypto not available for hashing");return bytesToHex(await t.subtle.digest("SHA-256",e))}async function hashBlobSHA256(e){const t=e;if(t&&"function"==typeof t.arrayBuffer){return hashArrayBufferSHA256(await t.arrayBuffer())}return hashArrayBufferSHA256(await new Response(e).arrayBuffer())}class l{async storeBlob(e,t,a){try{const o=await hashBlobSHA256(e);if(await r.media.has(o))return logInfo("Media dedup hit",{mediaHash:o,size:e.size,mimeType:t,scope:"media.storeBlob"}),o;let s;if(a?.useOPFS&&"undefined"!=typeof navigator&&navigator.storage?.getDirectory)try{const t=await navigator.storage.getDirectory(),r=await t.getDirectoryHandle("media",{create:!0}),a=await r.getFileHandle(o,{create:!0}),n=await a.createWritable();await n.write(e),await n.close(),s=`media/${o}`,logInfo("Media saved to OPFS",{mediaHash:o,path:s,scope:"media.storeBlob"})}catch(n){logError(n instanceof Error?n:new Error(String(n)),{scope:"media.storeBlob.opfs"}),s=void 0}return await r.media.put({mediaHash:o,blob:s?void 0:e,opfsPointer:s,mimeType:t,byteLength:e.size,validationMeta:a?.validationMeta,securityFlags:a?.securityFlags}),o}catch(o){throw logError(o instanceof Error?o:new Error(String(o)),{scope:"media.storeBlob"}),o}}async get(e){try{return await r.media.get(e)}catch(t){return logError(t instanceof Error?t:new Error(String(t)),{scope:"media.get"}),null}}async createObjectUrl(e){try{const a=await r.media.get(e);if(!a)return null;if(a.blob)return URL.createObjectURL(a.blob);if(a.opfsPointer&&"undefined"!=typeof navigator&&navigator.storage?.getDirectory)try{const e=await navigator.storage.getDirectory(),[t,r]=String(a.opfsPointer).split("/"),n=await e.getDirectoryHandle(t,{create:!1}),o=await n.getFileHandle(r,{create:!1}),s=await o.getFile();return URL.createObjectURL(s)}catch(t){return logError(t instanceof Error?t:new Error(String(t)),{scope:"media.createObjectUrl.opfs"}),null}return null}catch(a){return logError(a instanceof Error?a:new Error(String(a)),{scope:"media.createObjectUrl"}),null}}revokeObjectUrl(e){try{URL.revokeObjectURL(e)}catch(t){logError(t instanceof Error?t:new Error(String(t)),{scope:"media.revokeObjectUrl"})}}}const d=new l,u={totalXP:2500,level:5,currentLevelXP:100,nextLevelXP:500,cardsStudied:1250,studyTime:2400,accuracy:87.5,currentStreak:15,longestStreak:28,coins:150,gems:10,lastStudyDate:(new Date).toISOString(),joinDate:new Date(Date.now()-2592e6).toISOString()},h=[{id:"first_study",name:"First Steps",description:"Complete your first study session",icon:"ðŸŽ¯",unlockedAt:new Date(Date.now()-216e7).toISOString(),category:"study"},{id:"week_streak",name:"Week Warrior",description:"Study for 7 days in a row",icon:"ðŸ”¥",unlockedAt:new Date(Date.now()-864e6).toISOString(),category:"streak"}],g=[{id:"monthly_mastery",name:"Monthly Mastery Challenge",description:"Complete an intensive month-long study challenge with progressive difficulty",type:"monthly",target:1e3,current:245,reward:{xp:1500,coins:500,gems:50},expiresAt:new Date(Date.now()+2592e6).toISOString()},{id:"knowledge_seeker",name:"Knowledge Seeker",description:"Explore diverse subjects and maintain high accuracy throughout the month",type:"monthly",target:800,current:156,reward:{xp:1200,coins:400,gems:30},expiresAt:new Date(Date.now()+216e7).toISOString()}],m=[{id:"daily_grind",name:"Daily Grind",description:"Study 25 cards today",type:"daily",target:25,current:18,reward:{xp:50,coins:10},expiresAt:new Date(Date.now()+864e5).toISOString()},{id:"weekly_warrior",name:"Weekly Warrior",description:"Study 200 cards this week",type:"weekly",target:200,current:145,reward:{xp:200,coins:50,gems:5},expiresAt:new Date(Date.now()+2592e5).toISOString()},...g],y={global:[{userId:"demo1",username:"StudyMaster",score:5420,rank:1,change:0},{userId:"demo2",username:"FlashcardPro",score:4890,rank:2,change:1},{userId:"demo3",username:"MemoryWiz",score:4650,rank:3,change:-1},{userId:"demo4",username:"QuizKing",score:4200,rank:4,change:2},{userId:"demo_user",username:"Demo User",score:2500,rank:15,change:3}],friends:[{userId:"friend1",username:"StudyBuddy",score:3200,rank:1,change:0},{userId:"demo_user",username:"Demo User",score:2500,rank:2,change:1},{userId:"friend2",username:"LearningPal",score:2100,rank:3,change:-1}],weekly:[{userId:"demo1",username:"StudyMaster",score:890,rank:1,change:2},{userId:"demo_user",username:"Demo User",score:420,rank:8,change:5}],monthly:[{userId:"demo1",username:"StudyMaster",score:3200,rank:1,change:0},{userId:"demo_user",username:"Demo User",score:1800,rank:12,change:-2}]};class f{baseUrl="/api";isDemoUser(e){return"demo"===e.tokenType||"demo@studymaster.app"===e.email}async getUserStats(e){if(a.log("[USER_DATA_SERVICE]","START - getUserStats",{userId:e.id,isDemoUser:this.isDemoUser(e)}),this.isDemoUser(e))return a.log("[USER_DATA_SERVICE]","Returning demo user stats"),u;try{const t=await fetch(`${this.baseUrl}/users/${e.id}/stats`,{headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch user stats from REST API");const r=await t.json();return a.log("[USER_DATA_SERVICE]","REST API user stats fetched successfully"),r}catch(t){return a.warn("[USER_DATA_SERVICE]","REST API failed, using mock data",{apiError:t}),this.generatePersonalizedMockStats(e)}}async getUserActivity(e,t=30){if(this.isDemoUser(e))return this.generateDemoActivity(t);try{const r=await fetch(`${this.baseUrl}/users/${e.id}/activity?days=${t}`,{headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}});if(!r.ok)throw new Error("Failed to fetch user activity");return await r.json()}catch(r){return console.warn("Failed to fetch real user activity, using mock data:",r),this.generatePersonalizedActivity(e,t)}}async getUserAchievements(e){if(this.isDemoUser(e))return h;try{const t=await fetch(`${this.baseUrl}/users/${e.id}/achievements`,{headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch user achievements");return await t.json()}catch(t){return console.warn("Failed to fetch real user achievements, using mock data:",t),this.generatePersonalizedAchievements(e)}}async getUserChallenges(e){if(this.isDemoUser(e))return m;try{const t=await fetch(`${this.baseUrl}/users/${e.id}/challenges`,{headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch user challenges");return await t.json()}catch(t){return console.warn("Failed to fetch real user challenges, using mock data:",t),this.generatePersonalizedChallenges(e)}}async getLeaderboardData(e){if(this.isDemoUser(e))return y;try{const t=await fetch(`${this.baseUrl}/gamification/leaderboard`,{headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch leaderboard data");return await t.json()}catch(t){return console.warn("Failed to fetch real leaderboard data, using mock data:",t),this.generatePersonalizedLeaderboard(e)}}async getPerformanceMetrics(e){if(this.isDemoUser(e))return this.generateDemoPerformanceMetrics();try{const t=await fetch(`${this.baseUrl}/users/${e.id}/performance`,{headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch performance metrics");return await t.json()}catch(t){return console.warn("Failed to fetch real performance metrics, using mock data:",t),this.generatePersonalizedPerformanceMetrics(e)}}async getCompleteUserProfile(e){const[t,r,a,n,o]=await Promise.all([this.getUserStats(e),this.getUserActivity(e,30),this.getUserAchievements(e),this.getUserChallenges(e),this.getPerformanceMetrics(e)]);return{stats:t,activity:r,achievements:a,challenges:n,performance:o}}async resetAllUserData(e){if(!this.isDemoUser(e))try{if(!(await fetch(`${this.baseUrl}/users/${e.id}/reset`,{method:"POST",headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}})).ok)throw new Error("Failed to reset user data")}catch(t){console.warn("Failed to reset real user data via API:",t)}}generatePersonalizedMockStats(e){const t=this.hashString(e.email),r=Math.floor(t%60)+1;return{totalXP:Math.floor(t%1e3)+100,level:Math.floor(t%1e3/200)+1,currentLevelXP:t%200,nextLevelXP:200,cardsStudied:Math.floor(t%500)+50,studyTime:Math.floor(t%1200)+60,accuracy:75+t%20,currentStreak:Math.floor(t%15)+1,longestStreak:Math.floor(t%30)+5,coins:Math.floor(t%200)+50,gems:Math.floor(t%20)+5,lastStudyDate:(new Date).toISOString(),joinDate:new Date(Date.now()-24*r*60*60*1e3).toISOString()}}generatePersonalizedActivity(e,t){const r=[];for(let a=0;a<t;a++){const t=new Date(Date.now()-24*a*60*60*1e3),n=this.hashString(e.email+t.toDateString());n%4!=0&&r.push({date:t.toISOString().split("T")[0],cardsStudied:Math.floor(n%50)+5,studyTime:Math.floor(n%120)+10,accuracy:70+n%25,xpGained:Math.floor(n%100)+20})}return r.reverse()}generatePersonalizedAchievements(e){const t=this.hashString(e.email),r=[...h];return t%3==0&&r.push({id:"accuracy_master",name:"Accuracy Master",description:"Achieve 90% accuracy in a session",icon:"ðŸŽ¯",unlockedAt:new Date(Date.now()-432e6).toISOString(),category:"accuracy"}),r}generatePersonalizedChallenges(e){const t=[...m];return t.forEach(t=>{const r=this.hashString(e.email+t.id);t.current=Math.floor(r%80/100*t.target)}),t}generatePersonalizedLeaderboard(e){const t=this.hashString(e.email),r=Math.floor(t%1e3)+100,a=Math.floor(t%50)+5,n={...y};return n.global.push({userId:e.id,username:e.username,score:r,rank:a,change:Math.floor(t%10)-5}),n}generateDemoActivity(e){const t=[];for(let r=0;r<e;r++){const e=new Date(Date.now()-24*r*60*60*1e3);r%3!=0&&t.push({date:e.toISOString().split("T")[0],cardsStudied:Math.floor(40*Math.random())+10,studyTime:Math.floor(90*Math.random())+15,accuracy:80+Math.floor(15*Math.random()),xpGained:Math.floor(80*Math.random())+30})}return t.reverse()}generateDemoPerformanceMetrics(){return{weeklyProgress:{cardsStudied:180,studyTime:240,accuracy:87.5,goal:350},monthlyProgress:{cardsStudied:720,studyTime:1200,decksCompleted:8},studyPattern:{preferredTime:"evening",averageSessionLength:25,studyFrequency:5.2}}}generatePersonalizedPerformanceMetrics(e){const t=this.hashString(e.email);return{weeklyProgress:{cardsStudied:Math.floor(t%200)+50,studyTime:Math.floor(t%300)+60,accuracy:75+t%20,goal:300},monthlyProgress:{cardsStudied:Math.floor(t%800)+200,studyTime:Math.floor(t%1500)+300,decksCompleted:Math.floor(t%15)+3},studyPattern:{preferredTime:["morning","afternoon","evening"][t%3],averageSessionLength:Math.floor(t%30)+15,studyFrequency:3+t%4}}}hashString(e){let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t&=t}return Math.abs(t)}}const p=new f;async function exportAll(){await e();const[r,a,n,o,s,i,c,l,d,u,h]=await Promise.all([t.settings.get("settings"),t.users.toArray(),t.decks.toArray(),t.cards.toArray(),t.reviews.toArray(),t.media.toArray(),t.achievements.toArray(),t.challenges.toArray(),t.leaderboardCache.toArray(),t.mediaAnalytics?.toArray?.()??[],t.userOnlineLinks?.toArray?.()??[]]),g=i.map(({blob:e,...t})=>t),m={version:1,exportedAt:Date.now(),tables:{settings:r??{id:"settings",createdAt:Date.now(),updatedAt:Date.now()},users:a,decks:n,cards:o,reviews:s,media:g,achievements:c,challenges:l,leaderboardCache:d,mediaAnalytics:u,userOnlineLinks:h}};return logInfo("Export created",{scope:"exportImport.exportAll",counts:{users:a.length,decks:n.length,cards:o.length,reviews:s.length,media:g.length}}),m}async function exportToBlob(){const e=await exportAll(),t=JSON.stringify(e,null,2);return new Blob([t],{type:"application/json"})}async function downloadExport(e){const t=await exportToBlob();try{if("undefined"!=typeof window){const r=URL.createObjectURL(t),a=document.createElement("a");a.href=r,a.download=e||defaultExportFilename(),document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}}catch(r){logError(r instanceof Error?r:new Error(String(r)),{scope:"exportImport.downloadExport"})}return t}function defaultExportFilename(){const e=new Date,pad=e=>String(e).padStart(2,"0");return`studymaster-export-${`${e.getFullYear()}${pad(e.getMonth()+1)}${pad(e.getDate())}-${pad(e.getHours())}${pad(e.getMinutes())}${pad(e.getSeconds())}`}.json`}async function importAll(r,a){if(await e(),!r||"object"!=typeof r||!r.tables)throw new Error("Invalid import bundle");const n=!0===a?.includeEphemeral,o=!1!==a?.overwriteSettings,s={},i=r.tables;return await t.transaction("rw",[t.settings,t.users,t.decks,t.cards,t.reviews,t.media,t.achievements,t.challenges,t.leaderboardCache,t.mediaAnalytics,t.userOnlineLinks,t.syncQueue],async()=>{i.settings&&o&&await t.settings.put(i.settings),Array.isArray(i.users)&&i.users.length&&(await t.users.bulkPut(i.users),s.users=i.users.length),Array.isArray(i.decks)&&i.decks.length&&(await t.decks.bulkPut(i.decks),s.decks=i.decks.length),Array.isArray(i.cards)&&i.cards.length&&(await t.cards.bulkPut(i.cards),s.cards=i.cards.length),Array.isArray(i.reviews)&&i.reviews.length&&(await t.reviews.bulkPut(i.reviews),s.reviews=i.reviews.length),Array.isArray(i.media)&&i.media.length&&(await t.media.bulkPut(i.media),s.media=i.media.length),Array.isArray(i.achievements)&&i.achievements.length&&(await t.achievements.bulkPut(i.achievements),s.achievements=i.achievements.length),Array.isArray(i.challenges)&&i.challenges.length&&(await t.challenges.bulkPut(i.challenges),s.challenges=i.challenges.length),Array.isArray(i.leaderboardCache)&&i.leaderboardCache.length&&(await t.leaderboardCache.bulkPut(i.leaderboardCache),s.leaderboardCache=i.leaderboardCache.length),Array.isArray(i.mediaAnalytics)&&i.mediaAnalytics.length&&(await t.mediaAnalytics.bulkPut(i.mediaAnalytics),s.mediaAnalytics=i.mediaAnalytics.length),Array.isArray(i.userOnlineLinks)&&i.userOnlineLinks.length&&(await t.userOnlineLinks.bulkPut(i.userOnlineLinks),s.userOnlineLinks=i.userOnlineLinks.length),n&&Array.isArray(i.syncQueue)&&i.syncQueue.length&&(await t.syncQueue.bulkPut(i.syncQueue),s.syncQueue=i.syncQueue.length)}),logInfo("Import completed",{scope:"exportImport.importAll",counts:s}),{ok:!0,counts:s}}async function importFromFile(e,t){const r=await e.text();let a;try{a=JSON.parse(r)}catch(n){throw new Error("Invalid JSON file")}return importAll(a,t)}function toScopeKey(e){return"friends"===e?"friends:global":`${e}:global`}const w=6e5;function toCacheEntries(e){return e.map(e=>({rank:e.rank,name:e.username,anonymizedId:e.userId,score:e.score}))}function fromCacheEntries(e){return e.map(e=>({userId:e.anonymizedId,username:e.name,score:e.score,rank:e.rank,change:0}))}async function cacheWrite(e,t,a=w){await r.leaderboardCache.set({scope:toScopeKey(e),entries:toCacheEntries(t),ttlMs:a})}async function cacheRead(e,t=!1){const a=await r.leaderboardCache.get(toScopeKey(e),{ignoreTTL:t});return a?fromCacheEntries(a.entries):null}async function tryRemoteFetchAll(e){return p.getLeaderboardData(e)}async function tryRemoteSubmit(e,t,r,a){const n=await fetch("/api/leaderboard/submit",{method:"POST",headers:{"Content-Type":"application/json",...e.token?{Authorization:`Bearer ${e.token}`}:{},"X-Idempotency-Key":a},body:JSON.stringify({scope:t,score:r,userId:e.id,username:e.username,requestId:a})});if(!n.ok)throw new Error(`Remote submit failed: ${n.status}`)}async function enqueueSubmit(e,t,a){await r.syncQueue.enqueue({opType:"leaderboard:submit",payload:{scope:e,score:t,user:{id:a.id,username:a.username,token:a.token},queuedAt:Date.now()}})}function supportsBackgroundSync$1(){try{return"undefined"!=typeof window&&"serviceWorker"in navigator&&"SyncManager"in window}catch{return!1}}class v{async fetchAll(e){try{const t=await tryRemoteFetchAll(e);return await Promise.all([cacheWrite("global",t.global),cacheWrite("friends",t.friends),cacheWrite("weekly",t.weekly),cacheWrite("monthly",t.monthly)]),t}catch{const[e,t,r,a]=await Promise.all([cacheRead("global",!0).then(e=>e??[]),cacheRead("friends",!0).then(e=>e??[]),cacheRead("weekly",!0).then(e=>e??[]),cacheRead("monthly",!0).then(e=>e??[])]);return{global:e,friends:t,weekly:r,monthly:a}}}async fetchScope(e,t){return(await this.fetchAll(e))[t]||[]}async submit(e,t,r){const a=`lb_${e.id}_${t}_${r}_${Date.now()}`;try{return void(await tryRemoteSubmit(e,t,r,a))}catch{if(supportsBackgroundSync$1())return;await enqueueSubmit(t,r,e)}}}let b=null;function getLeaderboardService(){return b||(b=new v,b)}class S{updateInterval=3e4;subscribers=new Map;intervalId=null;activeInstances=0;subscribe(e,t){return this.subscribers.has(e)||this.subscribers.set(e,[]),this.subscribers.get(e).push(t),()=>{const r=this.subscribers.get(e);if(r){const e=r.indexOf(t);e>-1&&r.splice(e,1)}}}notify(e,t){const r=this.subscribers.get(e);r&&r.forEach(e=>e(t))}async getGlobalLearningStats(){try{const e=await this.fetchFromMultipleSources([()=>this.fetchFromDuolingoAPI(),()=>this.fetchFromKhanAcademyAPI(),()=>this.fetchFromCourseraAPI(),()=>this.fetchFromEducationalDataAPI()]);if(e)return this.notify("globalStats",e),e}catch(e){console.warn("Failed to fetch real global stats, using enhanced mock data:",e)}return this.generateEnhancedGlobalStats()}async getEducationalTrends(){try{const e=await this.fetchEducationalTrendsFromAPIs();if(e)return this.notify("educationalTrends",e),e}catch(e){console.warn("Failed to fetch real educational trends, using enhanced mock data:",e)}return this.generateEnhancedEducationalTrends()}async getLiveUserMetrics(){try{const e=await this.fetchLiveMetricsFromAPIs();if(e)return this.notify("liveMetrics",e),e}catch(e){console.warn("Failed to fetch real live metrics, using enhanced mock data:",e)}return this.generateEnhancedLiveMetrics()}async getMarketInsights(){try{const e=await this.fetchMarketInsightsFromAPIs();if(e)return this.notify("marketInsights",e),e}catch(e){console.warn("Failed to fetch real market insights, using enhanced mock data:",e)}return this.generateEnhancedMarketInsights()}async fetchFromDuolingoAPI(){try{const e=await fetch("https://www.duolingo.com/api/1/users/show?username=duolingo",{method:"GET",headers:{Accept:"application/json"}});if(e.ok){await e.json();return null}}catch(e){console.log("Duolingo API not accessible:",e)}return null}async fetchFromKhanAcademyAPI(){try{return null}catch(e){console.log("Khan Academy API not accessible:",e)}return null}async fetchFromCourseraAPI(){try{return null}catch(e){console.log("Coursera API not accessible:",e)}return null}async fetchFromEducationalDataAPI(){try{return null}catch(e){console.log("Educational data API not accessible:",e)}return null}async fetchFromMultipleSources(e){const t=(await Promise.allSettled(e.map(e=>e()))).filter(e=>"fulfilled"===e.status&&e.value).map(e=>e.value);return t.length>0?this.mergeDataSources(t):null}mergeDataSources(e){return e[0]}generateEnhancedGlobalStats(){const e=new Date,t=e.getHours(),r=e.getDay(),a=this.getTimeBasedMultiplier(t,r),n=2847392,o=15847293,s=23847;return{totalLearners:Math.floor(n+(1e3*Math.random()-500)),cardsStudiedToday:Math.floor(o*a+(1e4*Math.random()-5e3)),activeStudySessions:Math.floor(s*a+(1e3*Math.random()-500)),languagesBeingLearned:127+Math.floor(5*Math.random()),topSubjects:[{name:"Spanish",learners:Math.floor(847392*a)},{name:"JavaScript",learners:Math.floor(623847*a)},{name:"French",learners:Math.floor(534829*a)},{name:"Python",learners:Math.floor(487293*a)},{name:"German",learners:Math.floor(392847*a)}],studyTimeToday:Math.floor(1847293*a),lastUpdated:e.toISOString()}}generateEnhancedEducationalTrends(){const e=new Date;return{popularSubjects:[{subject:"Artificial Intelligence",growth:156.7,learners:892847},{subject:"Data Science",growth:134.2,learners:734829},{subject:"Cybersecurity",growth:128.9,learners:623847},{subject:"Cloud Computing",growth:119.4,learners:587293},{subject:"Machine Learning",growth:112.8,learners:534829},{subject:"Spanish Language",growth:89.3,learners:1247392},{subject:"Digital Marketing",growth:87.6,learners:423847},{subject:"UX/UI Design",growth:82.4,learners:392847}],learningMethods:[{method:"Spaced Repetition",effectiveness:94.7,usage:78.3},{method:"Active Recall",effectiveness:91.2,usage:65.8},{method:"Microlearning",effectiveness:87.9,usage:82.1},{method:"Gamification",effectiveness:84.6,usage:71.4},{method:"Peer Learning",effectiveness:81.3,usage:56.7}],studyPatterns:{peakHours:this.generatePeakHours(),weeklyTrends:this.generateWeeklyTrends()},lastUpdated:e.toISOString()}}generateEnhancedLiveMetrics(){const e=new Date,t=e.getHours(),r=this.getTimeBasedMultiplier(t,e.getDay());return{onlineUsers:Math.floor(47392*r+(1e3*Math.random()-500)),studyingSessions:Math.floor(23847*r+(500*Math.random()-250)),completedToday:Math.floor(1e3*Math.random()-500+184729),averageAccuracy:4*Math.random()-2+87.3,topPerformers:[{username:"StudyMaster_Pro",score:15847,country:"Singapore"},{username:"LearningNinja",score:14923,country:"South Korea"},{username:"FlashcardWiz",score:14756,country:"Finland"},{username:"MemoryChamp",score:14234,country:"Japan"},{username:"QuizMaster",score:13892,country:"Canada"}],lastUpdated:e.toISOString()}}generateEnhancedMarketInsights(){return{skillDemand:[{skill:"AI/Machine Learning",demand:94.7,growth:156.3},{skill:"Cloud Architecture",demand:91.2,growth:134.7},{skill:"Cybersecurity",demand:89.8,growth:128.9},{skill:"Data Analysis",demand:87.4,growth:119.2},{skill:"DevOps",demand:84.9,growth:112.6},{skill:"Full-Stack Development",demand:82.3,growth:98.4},{skill:"Digital Marketing",demand:78.7,growth:87.9},{skill:"UX Design",demand:76.2,growth:82.1}],industryTrends:[{industry:"Technology",skills:["AI/ML","Cloud Computing","Cybersecurity"],growth:145.7},{industry:"Healthcare",skills:["Data Analysis","Digital Health","Telemedicine"],growth:123.4},{industry:"Finance",skills:["Blockchain","FinTech","Risk Analysis"],growth:118.9},{industry:"Education",skills:["EdTech","Online Learning","Digital Pedagogy"],growth:134.2}],certificationValue:[{cert:"AWS Certified Solutions Architect",value:98.7,popularity:87.3},{cert:"Google Cloud Professional",value:96.2,popularity:82.1},{cert:"Certified Ethical Hacker",value:94.8,popularity:76.4},{cert:"PMP Certification",value:91.3,popularity:89.7},{cert:"Cisco CCNA",value:88.9,popularity:78.2}],lastUpdated:(new Date).toISOString()}}getTimeBasedMultiplier(e,t){let r=.7;e>=9&&e<=11||e>=14&&e<=16||e>=19&&e<=21?r=1.2:e>=6&&e<=23&&(r=1);return r*(0===t||6===t?.8:1)}generatePeakHours(){const e=[];for(let t=0;t<24;t++){let r=30;r=t>=9&&t<=11?85+10*Math.random():t>=14&&t<=16?90+10*Math.random():t>=19&&t<=21?95+10*Math.random():t>=6&&t<=23?60+20*Math.random():20+15*Math.random(),e.push({hour:t,activity:Math.floor(r)})}return e}generateWeeklyTrends(){const e=[8500,9200,9800,9500,8900,7200,6800];return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"].map((t,r)=>({day:t,sessions:Math.floor(e[r]+(1e3*Math.random()-500))}))}async fetchEducationalTrendsFromAPIs(){return null}async fetchLiveMetricsFromAPIs(){return null}async fetchMarketInsightsFromAPIs(){return null}startRealTimeUpdates(){return this.activeInstances++,1!==this.activeInstances||this.intervalId||(this.intervalId=setInterval(async()=>{try{const[e,t,r,a]=await Promise.all([this.getGlobalLearningStats(),this.getEducationalTrends(),this.getLiveUserMetrics(),this.getMarketInsights()]);this.notify("globalStats",e),this.notify("educationalTrends",t),this.notify("liveMetrics",r),this.notify("marketInsights",a)}catch(e){console.error("Error updating real-time data:",e)}},this.updateInterval)),()=>{this.stopRealTimeUpdates()}}stopRealTimeUpdates(){this.activeInstances=Math.max(0,this.activeInstances-1),0===this.activeInstances&&this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}forceStopRealTimeUpdates(){this.activeInstances=0,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.subscribers.clear()}}const k=new S,A=s.create({baseURL:"https://server-gxanj3vc3-daniel-perssons-projects-c35d58f6.vercel.app",withCredentials:!0}),I={initializeSession:async(e,t)=>(await A.post("/uams/session/initialize",{userId:e,deckId:t})).data,getNextCard:async e=>(await A.post("/uams/session/next-card",{sessionState:e})).data,processCardResponse:async(e,t,r)=>(await A.post("/uams/session/response",{sessionState:e,cardId:t,response:r})).data};class M{config;constructor(e={}){this.config={lookaheadBufferSize:10,emergencyBufferSize:5,challengeReserveSize:5,refreshThreshold:3,maxSessionDurationMinutes:120,adaptiveRefreshInterval:5e3,...e}}async initializeSession(e,t){return I.initializeSession(e,t)}async getNextCard(e){return I.getNextCard(e)}async processCardResponse(e,t,r){return I.processCardResponse(e,t,r)}}class C{contextHistory=[];performanceCache=new Map;async getCurrentContext(){const e={device:this.detectDevice(),networkQuality:await this.assessNetworkQuality()};let t=.9;if("mobile"===e.device)try{e.batteryLevel=await this.getBatteryLevel(),void 0!==e.batteryLevel&&(t+=.05)}catch(a){console.warn("Battery level detection failed:",a)}try{e.ambientNoise=await this.detectAmbientNoise(),e.lighting=await this.detectLightingConditions(),t+=.05}catch(a){console.warn("Ambient conditions detection failed:",a),t-=.1}const r={...e,confidence:Math.max(.5,t),detectionMethod:"multi-sensor-fusion",timestamp:(new Date).toISOString()};return this.contextHistory.push(r),this.contextHistory.length>100&&this.contextHistory.shift(),r}detectDevice(){const e=navigator.userAgent.toLowerCase(),t=navigator.platform?.toLowerCase()||"",r=["mobile","android","iphone","ipod","blackberry","windows phone"].some(t=>e.includes(t)),a=["ipad","tablet","kindle","playbook","silk"].some(t=>e.includes(t)),n=window.screen.width,o=window.screen.height,s=Math.max(n,o),i=Math.min(n,o),c="ontouchstart"in window||navigator.maxTouchPoints>0;if(a||c&&i>=768&&s>=1024)return"tablet";if(r||c&&s<=736)return"mobile";return t.includes("win")||t.includes("mac")||t.includes("linux")||!c?"desktop":"mobile"}async assessNetworkQuality(){if(!navigator.onLine)return"offline";try{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(e){const t=e.effectiveType,r=e.downlink,a=e.rtt;return"4g"===t&&r>10&&a<100?"excellent":("4g"===t||"3g"===t)&&r>2&&a<300||r>.5&&a<1e3?"good":"poor"}return await this.performLatencyTest()}catch(e){return console.warn("Network quality assessment failed:",e),"good"}}async performLatencyTest(){try{const e=performance.now(),t=await fetch("/api/ping",{method:"HEAD",cache:"no-cache"}),r=performance.now()-e;return t.ok?r<100?"excellent":r<300?"good":"poor":"poor"}catch(e){return console.warn("Latency test failed:",e),"poor"}}async getBatteryLevel(){try{const e=await(navigator.getBattery?.());if(e&&"number"==typeof e.level)return e.level;const t=navigator.battery||navigator.mozBattery||navigator.webkitBattery;return t&&"number"==typeof t.level?t.level:void 0}catch(e){return void console.warn("Battery level detection failed:",e)}}async detectAmbientNoise(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});return new Promise(t=>{const r=new(window.AudioContext||window.webkitAudioContext),a=r.createAnalyser();r.createMediaStreamSource(e).connect(a),a.fftSize=256;const n=a.frequencyBinCount,o=new Uint8Array(n);let s=0,i=0;const c=30,checkVolume=()=>{a.getByteFrequencyData(o);const l=o.reduce((e,t)=>e+t,0)/n;if(i+=l,s++,s<c)setTimeout(checkVolume,33);else{e.getTracks().forEach(e=>e.stop()),r.close();const a=i/s;t(a<20?"quiet":a<60?"moderate":"noisy")}};checkVolume()})}catch(e){return void console.warn("Ambient noise detection failed:",e)}}async detectLightingConditions(){try{if("screen"in navigator&&"brightness"in navigator.screen){const e=navigator.screen.brightness;return e<.3?"dim":e>.8?"bright":"optimal"}return await this.detectLightingViaCamera()}catch(e){return void console.warn("Lighting detection failed:",e)}}async detectLightingViaCamera(){try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});return new Promise(t=>{const r=document.createElement("video"),a=document.createElement("canvas"),n=a.getContext("2d");r.srcObject=e,r.play(),r.addEventListener("loadedmetadata",()=>{a.width=r.videoWidth,a.height=r.videoHeight,setTimeout(()=>{if(n){n.drawImage(r,0,0);let o=0;const s=n.getImageData(0,0,a.width,a.height).data;for(let e=0;e<s.length;e+=4){o+=.299*s[e]+.587*s[e+1]+.114*s[e+2]}const i=o/(s.length/4);e.getTracks().forEach(e=>e.stop()),t(i<50?"dim":i>200?"bright":"optimal")}},500)})})}catch(e){return void console.warn("Camera-based lighting detection failed:",e)}}analyzeContextualInsights(e){const t=this.groupPerformanceByContext(e),r=this.findOptimalConditions(t),a=this.contextHistory[this.contextHistory.length-1];return{optimalStudyConditions:r,currentConditionScore:this.scoreCurrentConditions(a,r),improvementSuggestions:this.generateImprovementSuggestions(a,r),historicalPerformance:Array.from(t.values())}}getEnvironmentalAdaptations(e){let t=0,r=25;const a={contrastAdjustment:0,fontSizeAdjustment:0,colorScheme:"auto"},n={enableSoundEffects:!0,volumeAdjustment:.7};switch(e.device){case"mobile":t-=.5,r=20,a.fontSizeAdjustment=.2;break;case"tablet":r=30,a.fontSizeAdjustment=.1;break;case"desktop":r=45}switch(e.networkQuality){case"poor":case"offline":t-=1,n.enableSoundEffects=!1;break;case"good":t-=.2}switch(void 0!==e.batteryLevel&&e.batteryLevel<.3&&(t-=.5,r=15,a.colorScheme="dark"),e.ambientNoise){case"noisy":t-=.3,n.enableSoundEffects=!1;break;case"quiet":n.volumeAdjustment=.5}switch(e.lighting){case"dim":a.contrastAdjustment=.3,a.colorScheme="dark",t-=.2;break;case"bright":a.contrastAdjustment=-.2,a.colorScheme="light"}return{difficultyAdjustment:Math.max(-3,Math.min(3,t)),recommendedBreakFrequency:r,visualOptimizations:a,audioOptimizations:n}}async trackContextChanges(){const e=this.contextHistory[this.contextHistory.length-1],t=await this.getCurrentContext();e&&this.hasSignificantContextChange(e,t)&&this.onContextChange?.(t,e)}hasSignificantContextChange(e,t){return e.device!==t.device||(e.networkQuality!==t.networkQuality||(!!(e.batteryLevel&&t.batteryLevel&&Math.abs(e.batteryLevel-t.batteryLevel)>.2)||(e.ambientNoise!==t.ambientNoise||e.lighting!==t.lighting)))}groupPerformanceByContext(e){return new Map}findOptimalConditions(e){return{device:"desktop",networkQuality:"excellent",batteryLevel:void 0,ambientNoise:"quiet",lighting:"optimal"}}scoreCurrentConditions(e,t){if(!e)return.5;let r=1;return e.device!==t.device&&(r-=.1),e.networkQuality!==t.networkQuality&&(r-="poor"===e.networkQuality?.3:.1),e.ambientNoise!==t.ambientNoise&&(r-=.15),e.lighting!==t.lighting&&(r-=.1),"mobile"===e.device&&e.batteryLevel&&e.batteryLevel<.3&&(r-=.2),Math.max(0,r)}generateImprovementSuggestions(e,t){const r=[];return e?("poor"===e.networkQuality&&r.push("Consider switching to a better network connection for optimal performance"),"noisy"===e.ambientNoise&&r.push("Find a quieter environment or use noise-canceling headphones"),"dim"===e.lighting?r.push("Improve lighting conditions for better visual clarity"):"bright"===e.lighting&&r.push("Reduce screen glare or move to a less bright environment"),"mobile"===e.device&&e.batteryLevel&&e.batteryLevel<.3&&r.push("Charge your device or switch to a desktop for longer study sessions"),r):r}onContextChange}function safeByteLength(e){if(!e)return 0;if("number"==typeof e.byteLength)return e.byteLength;try{return e.blob?e.blob.size:0}catch{return 0}}class E{async getUsage(){await e();const[r,a,n,o,s,i]=await Promise.all([t.media.toArray(),t.decks.count(),t.cards.count(),t.reviews.count(),t.achievements.count(),t.challenges.count()]),c=r.reduce((e,t)=>e+safeByteLength(t),0),l=r.length;let d;try{if(navigator?.storage?.estimate){const e=await navigator.storage.estimate(),t=e.usageDetails;d={quota:e.quota,usage:e.usage,...t?{usageDetails:Object.fromEntries(Object.entries(t))}:{}}}}catch{}return{mediaBytes:c,mediaCount:l,decksCount:a,cardsCount:n,reviewsCount:o,achievementsCount:s,challengesCount:i,estimate:d,measuredAt:Date.now()}}async purgeUnusedMedia(){await e();const[r,a]=await Promise.all([t.cards.toArray(),t.media.toArray()]),n=this.collectReferencedMedia(r);let o=0,s=0;for(const e of a)n.has(e.mediaHash)||(s+=safeByteLength(e),await t.media.delete(e.mediaHash),o++);return{removedCount:o,removedBytes:s,keptCount:a.length-o}}async purgeAllMedia(){await e();const r=await t.media.toArray(),a=r.reduce((e,t)=>e+safeByteLength(t),0),n=r.length;return await t.media.clear(),{removedCount:n,removedBytes:a,keptCount:0}}collectReferencedMedia(e){const t=new Set;for(const r of e)if(Array.isArray(r.mediaRefs))for(const e of r.mediaRefs)"string"==typeof e&&e.length>0&&t.add(e);return t}}const L=new E;function supportsBackgroundSync(){try{return"undefined"!=typeof window&&"serviceWorker"in navigator&&"SyncManager"in window}catch{return!1}}async function flushLeaderboardSubmit(e){const t=e?.payload;if(!t||!t.user||!t.user.id)return await r.syncQueue.remove(e.queueId),!0;const a=t.requestId??`lb_${t.user.id}_${t.scope}_${t.score}_${t.queuedAt}`;try{const n=await fetch("/api/leaderboard/submit",{method:"POST",headers:{"Content-Type":"application/json",...t.user.token?{Authorization:`Bearer ${t.user.token}`}:{},"X-Idempotency-Key":a},body:JSON.stringify({scope:t.scope,score:t.score,userId:t.user.id,username:t.user.username,requestId:a})});if(!n.ok)throw new Error(`HTTP ${n.status}`);return await r.syncQueue.remove(e.queueId),!0}catch(n){return await r.syncQueue.markAttempt(e.queueId,String(n?.message??n)),!1}}async function flushSyncQueueOnce(e=50){const t=await r.syncQueue.list(e);let a=0;for(const o of t)try{if((o.attemptCount??0)>8){await r.syncQueue.remove(o.queueId);continue}if("leaderboard:submit"===o.opType)await flushLeaderboardSubmit(o)&&a++;else await r.syncQueue.remove(o.queueId)}catch(n){await r.syncQueue.markAttempt(o.queueId,String(n?.message??n))}return a}function initSyncQueueFlusher(e){if("undefined"==typeof window)return;const doFlush=async()=>{if(!supportsBackgroundSync()&&navigator.onLine)try{await flushSyncQueueOnce(100)}catch{}};doFlush(),window.addEventListener("online",()=>{doFlush()});const t=12e4,r=window.setInterval(()=>{doFlush()},t);window.__syncQueueFlusherCleanup=()=>clearInterval(r)}export{C as E,M as U,logInfo as a,logWarning as b,unlinkAccount as c,linkAccount as d,ensureLocalProfile as e,p as f,downloadExport as g,importFromFile as h,isLinked as i,getLeaderboardService as j,initSyncQueueFlusher as k,logError as l,d as m,k as r,L as s,updateLocalProfile as u};
//# sourceMappingURL=services-BlEXT7_S.js.map
