const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/zip-vendor-DKmsGQLg.js","assets/react-vendor-D7Istm-s.js","assets/vendor-DojJshIj.js","assets/ui-vendor-C86Gg0gy.js","assets/sql-vendor-C4AgKQME.js"])))=>i.map(i=>d[i]);
import{c as e,a as t,p as r}from"./data-vendor-x8Mxs_7j.js";import{r as a,g as s,d as n}from"./anki-services-DlKSjqeH.js";import{m as o,e as i,u as c,i as d,c as l,d as u}from"./services-BlEXT7_S.js";const g="modulepreload",assetsURL=function(e){return"/"+e},m={},p=function preload(e,t,r){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),n=s?.nonce||s?.getAttribute("nonce");function allSettled(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))}a=allSettled(t.map(e=>{if((e=assetsURL(e))in m)return;m[e]=!0;const t=e.endsWith(".css"),r=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${r}`))return;const a=document.createElement("link");return a.rel=t?"stylesheet":g,t||(a.as="script"),a.crossOrigin="",a.href=e,n&&a.setAttribute("nonce",n),document.head.appendChild(a),t?new Promise((t,r)=>{a.addEventListener("load",t),a.addEventListener("error",()=>r(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function handlePreloadError(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(t=>{for(const e of t||[])"rejected"===e.status&&handlePreloadError(e.reason);return e().catch(handlePreloadError)})};function createNewCard(e,t,r={type:"basic"},a=[]){return{frontContent:e,backContent:t,cardType:r,mediaRefs:a,state:"new",queue:0,due:0,ivl:0,factor:2500,reps:0,lapses:0,left:0,learningStep:0,graduationInterval:1,easyInterval:4,totalStudyTime:0,averageAnswerTime:0,flags:0,originalDue:0,originalDeck:"",xpAwarded:0,difficultyRating:3}}function uuid(){try{const e=globalThis.crypto;if(e&&"function"==typeof e.randomUUID)return e.randomUUID()}catch{}return"id_"+Math.random().toString(36).slice(2,10)}function buildNewDeckFromDomain(e){return{deckId:uuid(),name:e.title,description:e.description,meta:{userId:e.userId,tags:e.tags??[],category:e.category??null,settings:e.settings??null,advancedSettings:e.advancedSettings??null,isPublic:e.isPublic??!1}}}function buildNewCardFromDomain(e){const t=new Set(["new","learning","review","relearning"]).has(e.state)?e.state:"new";return{cardId:uuid(),deckId:e.deckId,fields:{front:e.frontContent,back:e.backContent},mediaRefs:(e.mediaRefs??[]).map(e=>e.id).filter(Boolean),state:t,ease:e.easeFactor??250,interval:e.intervalDays??0,dueAt:null,lapses:0}}function mapDeckUpdatesToRepo(e){const t={};"string"==typeof e.title&&(t.name=e.title),"string"==typeof e.description&&(t.description=e.description);const r={};return e.tags&&(r.tags=e.tags),e.category&&(r.category=e.category),e.settings&&(r.settings=e.settings),e.advancedSettings&&(r.advancedSettings=e.advancedSettings),Object.keys(r).length&&(t.meta=r),t}const h={newCardsPerDay:20,maxReviewsPerDay:100,easyBonus:1.3,intervalModifier:1,maximumInterval:36500,minimumInterval:1};async function persistCreateDeck(e){try{await a.decks.create(buildNewDeckFromDomain(e))}catch(t){console.warn("[deckStore] repo createDeck failed",t)}}async function persistAddCard(e,t){try{await a.cards.create(buildNewCardFromDomain({deckId:e,frontContent:t.frontContent,backContent:t.backContent,mediaRefs:t.mediaRefs,state:t.state,easeFactor:t.easeFactor,intervalDays:t.intervalDays}))}catch(r){console.warn("[deckStore] repo addCard failed",r)}}const cleanFieldContent=e=>e.replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").trim(),extractPlainText=e=>e.replace(/<[^>]*>/g,"").replace(/\[sound:[^\]]*\]/g,"").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").trim(),detectBestFieldCombination=e=>{if(0===e.length)return{frontIndex:0,backIndex:1};const t=e[0].length,r=[];for(let a=0;a<t;a++)for(let s=a+1;s<t;s++){let t=0,n=0;for(const r of e){const e=extractPlainText(r[a]||""),o=extractPlainText(r[s]||"");e&&o&&(n++,e.length>2&&o.length>2&&(t+=10),e!==o&&(t+=5),e.match(/^\[sound:/)||o.match(/^\[sound:/)||(t+=3),e.match(/^\d+$/)||o.match(/^\d+$/)||(t+=2))}const o=n>0?t/n:0;r.push({frontIndex:a,backIndex:s,score:o})}return r.sort((e,t)=>t.score-e.score),r.length>0&&r[0].score>0?(console.log(`Best field combination: ${r[0].frontIndex} -> ${r[0].backIndex} (score: ${r[0].score})`),{frontIndex:r[0].frontIndex,backIndex:r[0].backIndex}):t>=3?{frontIndex:0,backIndex:2}:{frontIndex:0,backIndex:1}},getMimeTypeFromFilename=e=>({jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",svg:"image/svg+xml",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",webm:"video/webm"}[e.toLowerCase().split(".").pop()||""]||"application/octet-stream"),parseApkgFile=async e=>{try{const[{default:a},{default:s}]=await Promise.all([p(()=>import("./zip-vendor-DKmsGQLg.js").then(e=>e.j),__vite__mapDeps([0,1,2,3])),p(()=>import("./sql-vendor-C4AgKQME.js").then(e=>e.s),__vite__mapDeps([4,1,2,3]))]),n=await s({locateFile:e=>e.endsWith(".wasm")?"/sql-wasm.wasm":`/${e}`}),o=await e.arrayBuffer(),i=new a,c=await i.loadAsync(o),d=c.file("collection.anki2");if(!d)throw new Error("Invalid .apkg file: collection.anki2 not found");const l=await d.async("arraybuffer"),u=new n.Database(new Uint8Array(l)),g=u.exec("SELECT decks FROM col LIMIT 1");let m=e.name.replace(/\.apkg$/,"");if(g.length>0&&g[0].values.length>0)try{const e=g[0].values[0][0],t=JSON.parse(e),r=Object.keys(t).filter(e=>"1"!==e);r.length>0&&(m=t[r[0]].name||m)}catch(t){console.warn("Could not parse deck names from .apkg file, using filename")}const h=u.exec("\n      SELECT n.flds, n.tags, c.type\n      FROM notes n\n      JOIN cards c ON n.id = c.nid\n      WHERE c.type >= 0\n      ORDER BY n.id\n    "),S=[];if(h.length>0){const e=Math.min(10,h[0].values.length),t=[];for(let s=0;s<e;s++){const e=h[0].values[s][0].split("");t.push(e)}const{frontIndex:r,backIndex:a}=detectBestFieldCombination(t);console.log(`Using field combination: ${r} (front) -> ${a} (back)`);for(const s of h[0].values){const e=s[0].split("");if(e.length>Math.max(r,a)){const t=cleanFieldContent(e[r]||""),s=cleanFieldContent(e[a]||"");t&&s&&t!==s&&S.push({front:t,back:s})}}}if(u.close(),0===S.length)throw new Error("No valid cards found in the .apkg file");const f=[],k=c.file("media");let w={};if(k)try{const e=await k.async("text");w=JSON.parse(e),console.log(`Found media mapping with ${Object.keys(w).length} entries`)}catch(r){console.warn("Failed to parse media mapping:",r)}for(const[e,t]of Object.entries(c.files)){if(t.dir||"collection.anki2"===e||"media"===e)continue;const a=/^\d+$/.test(e),s=/\.(jpg|jpeg|png|gif|svg|mp3|wav|ogg|mp4|webm)$/i.test(e);if(a||s)try{const r=await t.async("blob"),a=w[e]||e;f.push({filename:a,data:r}),console.log(`Extracted media: ${e} -> ${a} (${r.size} bytes)`)}catch(r){console.warn(`Failed to extract media file: ${e}`,r)}}return console.log(`Successfully parsed ${S.length} cards and ${f.length} media files from .apkg`),{name:m,cards:S,mediaFiles:f}}catch(a){throw console.error("Error parsing .apkg file:",a),new Error(`Failed to parse .apkg file: ${a instanceof Error?a.message:"Unknown error"}`)}},S=e()(t((e,t)=>({decks:[],cards:{},currentStudySession:null,isLoading:!1,error:null,importProgress:0,importStatus:null,hydrated:!1,currentUserId:null,createDeck:async t=>{e({isLoading:!0,error:null});try{const{user:r}=f.getState(),a=r?.id||"local-user",s={...t,userId:a,id:crypto.randomUUID(),createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),settings:{...h,...t.settings}};return e(e=>({decks:[...e.decks,s],cards:{...e.cards,[s.id]:[]},isLoading:!1})),persistCreateDeck(t),s}catch(r){throw e({error:"Failed to create deck",isLoading:!1}),r}},updateDeck:async(t,r)=>{e({isLoading:!0,error:null});try{e(e=>({decks:e.decks.map(e=>e.id===t?{...e,...r,updatedAt:(new Date).toISOString()}:e),isLoading:!1}));try{a.decks.update(t,mapDeckUpdatesToRepo(r))}catch(s){console.warn("[deckStore] repo updateDeck failed",s)}}catch(n){throw e({error:"Failed to update deck",isLoading:!1}),n}},deleteDeck:async t=>{e({isLoading:!0,error:null});try{e(e=>{const{[t]:r,...a}=e.cards;return{decks:e.decks.filter(e=>e.id!==t),cards:a,isLoading:!1}});try{a.decks.remove(t)}catch(r){console.warn("[deckStore] repo deleteDeck failed",r)}}catch(s){throw e({error:"Failed to delete deck",isLoading:!1}),s}},getDeck:e=>t().decks.find(t=>t.id===e),addCard:async(t,r)=>{e({isLoading:!0,error:null});try{const a={...r,id:crypto.randomUUID(),deckId:t,createdAt:(new Date).toISOString(),easeFactor:2.5,intervalDays:0,nextReview:(new Date).toISOString(),reviewCount:0,lapseCount:0};return e(e=>{const r=[...e.cards[t]||[],a];return{cards:{...e.cards,[t]:r},decks:e.decks.map(e=>e.id===t?{...e,cardCount:r.length,updatedAt:(new Date).toISOString()}:e),isLoading:!1}}),persistAddCard(t,a),a}catch(a){throw e({error:"Failed to add card",isLoading:!1}),a}},addCardBulk:async(r,a)=>{try{const s=t().cards[r]||[],n=`${a.frontContent.trim().toLowerCase()}|${a.backContent.trim().toLowerCase()}`;if(s.some(e=>`${e.frontContent.trim().toLowerCase()}|${e.backContent.trim().toLowerCase()}`===n))return console.log("Skipping duplicate card:",a.frontContent),{...a,id:"duplicate-skipped",deckId:r,createdAt:(new Date).toISOString(),easeFactor:2.5,intervalDays:0,nextReview:(new Date).toISOString(),reviewCount:0,lapseCount:0};const o={...a,id:crypto.randomUUID(),deckId:r,createdAt:(new Date).toISOString(),easeFactor:2.5,intervalDays:0,nextReview:(new Date).toISOString(),reviewCount:0,lapseCount:0};return e(e=>{const t=[...e.cards[r]||[],o];return{cards:{...e.cards,[r]:t},decks:e.decks.map(e=>e.id===r?{...e,cardCount:t.length,updatedAt:(new Date).toISOString()}:e)}}),"duplicate-skipped"!==o.id&&persistAddCard(r,o),o}catch(s){throw console.error("Failed to add card during bulk import:",s),s}},createDeckBulk:async t=>{try{const{user:r}=f.getState(),a=r?.id||"local-user",s={...t,userId:a,id:crypto.randomUUID(),createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),settings:{...h,...t.settings}};return e(e=>({decks:[...e.decks,s],cards:{...e.cards,[s.id]:[]}})),persistCreateDeck(t),s}catch(r){throw console.error("Failed to create deck during bulk import:",r),r}},addCardsBatch:async(r,a)=>{try{const s=t().cards[r]||[],n=new Set(s.map(e=>`${e.frontContent.trim().toLowerCase()}|${e.backContent.trim().toLowerCase()}`)),o=a.filter(e=>{const t=`${e.frontContent.trim().toLowerCase()}|${e.backContent.trim().toLowerCase()}`;return!n.has(t)});if(console.log(`Batch processing: ${a.length} cards submitted, ${o.length} unique cards to add`),0===o.length)return console.log("No new unique cards to add in this batch"),[];const i=o.map(e=>({...e,id:crypto.randomUUID(),deckId:r,createdAt:(new Date).toISOString(),easeFactor:2.5,intervalDays:0,nextReview:(new Date).toISOString(),reviewCount:0,lapseCount:0}));e(e=>{const t=[...e.cards[r]||[],...i];return{cards:{...e.cards,[r]:t},decks:e.decks.map(e=>e.id===r?{...e,cardCount:t.length,updatedAt:(new Date).toISOString()}:e)}});for(const e of i)persistAddCard(r,e);return i}catch(s){throw console.error("Failed to add cards during batch import:",s),s}},updateCard:async(t,r)=>{e({isLoading:!0,error:null});try{e(e=>{const a={...e.cards};for(const s in a)a[s]=a[s].map(e=>e.id===t?{...e,...r}:e);return{cards:a,isLoading:!1}})}catch(a){throw e({error:"Failed to update card",isLoading:!1}),a}},deleteCard:async t=>{e({isLoading:!0,error:null});try{let s="";e(e=>{const r={...e.cards};for(const a in r){if(-1!==r[a].findIndex(e=>e.id===t)){r[a]=r[a].filter(e=>e.id!==t),s=a;break}}return{cards:r,decks:e.decks.map(e=>e.id===s?{...e,cardCount:r[s].length,updatedAt:(new Date).toISOString()}:e),isLoading:!1}});try{a.cards.remove(t)}catch(r){console.warn("[deckStore] repo deleteCard failed",r)}}catch(s){throw e({error:"Failed to delete card",isLoading:!1}),s}},deleteCardsBatch:async(t,r)=>{e({isLoading:!0,error:null});try{e(e=>{const a={...e.cards},s=(a[t]||[]).filter(e=>!r.includes(e.id));return a[t]=s,{cards:a,decks:e.decks.map(e=>e.id===t?{...e,cardCount:s.length,updatedAt:(new Date).toISOString()}:e),isLoading:!1}});for(const e of r)try{a.cards.remove(e)}catch(s){console.warn(`[deckStore] repo deleteCardsBatch failed for card ${e}`,s)}}catch(n){throw e({error:"Failed to delete cards in batch",isLoading:!1}),n}},getCards:e=>t().cards[e]||[],importAnkiDeck:async r=>{const{setImportProgress:a,resetImportProgress:n}=t();e({isLoading:!0,error:null}),n();try{const l=r.name.toLowerCase();if(l.endsWith(".apkg")){a(10,"Reading file...");const{name:l,cards:u,mediaFiles:g}=await parseApkgFile(r);console.log(`Parsed .apkg: ${l} with ${u.length} cards and ${g.length} media files`);const{user:m}=f.getState(),p=m?.id||"local-user";if(t().decks.find(e=>e.title===l&&e.userId===p))throw new Error(`A deck named "${l}" already exists. Please rename the deck or the file before importing.`);a(30,"Creating deck...");const S=await t().createDeckBulk({userId:p,title:l,description:`Imported Anki deck with ${u.length} cards`,cardCount:0,isPublic:!1,settings:h,category:"imported"});if(g.length>0){console.log(`[IMPORT] Starting media storage for ${g.length} files`),a(35,`Storing ${g.length} media files...`);const e=s(),t=[];for(let r=0;r<g.length;r++){const e=g[r];try{const s=e.data.type||getMimeTypeFromFilename(e.filename);console.log(`[IMPORT] Storing media ${r+1}/${g.length}: ${e.filename} (${s}, ${e.data.size} bytes)`);const n=await o.storeBlob(e.data,s);console.log(`[IMPORT] Stored ${e.filename} with hash: ${n}`),t.push({id:n,originalFilename:e.filename,filename:e.filename,mimeType:s,blob:e.data}),r%10==0&&a(35+5*r/g.length,`Stored ${r}/${g.length} media files...`)}catch(i){console.error(`[IMPORT] Failed to store media file: ${e.filename}`,i)}}console.log(`[IMPORT] Stored ${t.length} media files, building mappings for deck ${S.id}`),await e.buildMappingsFromImport(S.id,t,p),console.log(`[IMPORT] Built media mappings for deck ${S.id}`),console.log("[IMPORT] MediaContext mappings count:",e.urlMappings.get(S.id)?.size||0)}else console.log("[IMPORT] No media files found in .apkg");a(40,`Importing ${u.length} cards...`);const k=[],w=new Set;for(const e of u){const t=`${e.front.trim().toLowerCase()}|${e.back.trim().toLowerCase()}`;w.has(t)||(w.add(t),k.push(e))}console.log(`Removed ${u.length-k.length} duplicates from Anki cards. Processing ${k.length} unique cards.`);const y=100;let I=0;const C=k.length;console.log(`Starting batch import of ${C} unique cards`);for(let e=0;e<C;e+=y){const r=k.slice(e,e+y),s=r.map(e=>createNewCard(e.front,e.back,{type:"basic"},[]));try{console.log(`Processing batch ${Math.floor(e/y)+1}/${Math.ceil(C/y)} (${r.length} cards)`),await t().addCardsBatch(S.id,s),I+=r.length;const n=40+50*Math.min(e+y,C)/C;a(n,`Imported ${I}/${C} cards...`),console.log(`Batch completed. Progress: ${n.toFixed(1)}%`),await new Promise(e=>setTimeout(e,50))}catch(c){console.error("Failed to import batch:",c);for(const e of r)try{await t().addCardBulk(S.id,createNewCard(e.front,e.back,{type:"basic"},[])),I++}catch(d){console.warn("Failed to import individual card:",e,d)}a(40+50*Math.min(e+y,C)/C,`Imported ${I}/${C} cards...`)}}return console.log(`Batch import completed. Total successful: ${I}`),a(95,"Finalizing import..."),await t().updateDeck(S.id,{description:`Imported Anki deck with ${I} cards`}),a(100,"Import completed!"),setTimeout(()=>{n()},1e3),e({isLoading:!1}),S}if(l.endsWith(".txt")||l.endsWith(".tsv")||l.endsWith(".csv")){a(10,"Reading text file...");const s=await r.text();let n="\t";l.endsWith(".csv")&&(n=","),a(20,"Processing text content...");const o=s.replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim(),i=await t().importFromText(r.name.replace(/\.[^/.]+$/,""),o,n);return e({isLoading:!1}),i}{a(10,"Reading file as text...");const s=await r.text();a(20,"Processing content...");const n=s.replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim(),o=await t().importFromText(r.name.replace(/\.[^/.]+$/,""),n,"\t");return e({isLoading:!1}),o}}catch(l){const t=l instanceof Error?l.message:"Failed to import Anki deck";throw e({error:t,isLoading:!1}),n(),l}},importFromText:async(r,a,s="\t")=>{const{setImportProgress:n,resetImportProgress:o}=t();e({isLoading:!0,error:null});try{n(30,"Processing text content...");const d=a.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\\u0000/g,"").replace(/[\\u0001-\\u0008\\u000B\\u000C\\u000E-\\u001F\\u007F]/g,"").trim().split("\n").map(e=>e.trim()).filter(e=>e.length>0);if(0===d.length)throw new Error("No valid content found in the file");n(40,"Creating deck...");const{user:l}=f.getState(),u=l?.id||"local-user",g=await t().createDeckBulk({userId:u,title:r,description:`Imported deck with ${d.length} cards`,cardCount:0,isPublic:!1,settings:h,category:"imported"});n(50,`Importing ${d.length} cards...`);const m=[];let p=0;for(let e=0;e<d.length;e++){const t=d[e];try{let e;if(e=","===s&&t.includes('"')?t.split(",").map(e=>e.replace(/^"(.*)"$/,"$1").trim()):t.split(s),e.length>=2){const t=e[0].trim(),r=e[1].trim();t&&r?m.push(createNewCard(t,r,{type:"basic"},[])):p++}else p++}catch(i){console.warn("Failed to parse line:",t,i),p++}}const S=[],k=new Set;for(const e of m){const t=`${e.frontContent.trim().toLowerCase()}|${e.backContent.trim().toLowerCase()}`;k.has(t)||(k.add(t),S.push(e))}console.log(`Removed ${m.length-S.length} duplicates from parsed cards. Processing ${S.length} unique cards.`);const w=100;let y=0;console.log(`Starting text import batch processing of ${S.length} unique cards`);for(let e=0;e<S.length;e+=w){const r=S.slice(e,e+w);try{console.log(`Processing text batch ${Math.floor(e/w)+1}/${Math.ceil(S.length/w)} (${r.length} cards)`);const a=await t().addCardsBatch(g.id,r);y+=a.length;const s=50+40*Math.min(e+w,S.length)/S.length;n(s,`Imported ${y}/${S.length} cards...`),console.log(`Text batch completed. Progress: ${s.toFixed(1)}%, Added: ${a.length} cards`),await new Promise(e=>setTimeout(e,50))}catch(i){console.error("Failed to import text batch:",i);for(const e of r)try{"duplicate-skipped"!==(await t().addCardBulk(g.id,e)).id&&y++}catch(c){console.warn("Failed to import individual text card:",e,c)}n(50+40*Math.min(e+w,S.length)/S.length,`Imported ${y}/${S.length} cards...`)}}if(console.log(`Text import batch processing completed. Total successful: ${y}`),n(95,"Finalizing import..."),await t().updateDeck(g.id,{description:`Imported deck with ${y} cards${p>0?` (${p} lines skipped)`:""}`}),0===y)throw new Error("No valid cards could be imported. Please check the file format.");return n(100,"Import completed!"),setTimeout(()=>{o()},1e3),e({isLoading:!1}),g}catch(d){throw e({error:"Failed to import from text",isLoading:!1}),o(),d}},loadExampleDecks:async()=>{e({isLoading:!0,error:null});try{const r=t(),a=new Set(r.decks.map(e=>e.title));if(["Spanish Vocabulary","JavaScript Concepts","World Capitals"].some(e=>a.has(e)))return console.log("Example decks already exist, skipping load"),void e({isLoading:!1});const s=[{title:"Spanish Vocabulary",description:"Essential Spanish words for beginners",category:"language",cards:[{front:"Hello",back:"Hola"},{front:"Goodbye",back:"AdiÃ³s"},{front:"Thank you",back:"Gracias"},{front:"Please",back:"Por favor"},{front:"Yes",back:"SÃ­"},{front:"No",back:"No"},{front:"Water",back:"Agua"},{front:"Food",back:"Comida"},{front:"House",back:"Casa"},{front:"Car",back:"Coche"}]},{title:"JavaScript Concepts",description:"Important JavaScript programming concepts",category:"programming",cards:[{front:"What is a closure?",back:"A closure is a function that has access to variables in its outer (enclosing) scope even after the outer function has returned."},{front:"What is hoisting?",back:"Hoisting is JavaScript's default behavior of moving declarations to the top of their scope."},{front:"What is the difference between let and var?",back:"let has block scope and cannot be redeclared, while var has function scope and can be redeclared."},{front:"What is a Promise?",back:"A Promise is an object representing the eventual completion or failure of an asynchronous operation."},{front:"What is async/await?",back:"async/await is syntactic sugar for working with Promises, making asynchronous code look more like synchronous code."}]},{title:"World Capitals",description:"Capital cities of countries around the world",category:"geography",cards:[{front:"France",back:"Paris"},{front:"Germany",back:"Berlin"},{front:"Italy",back:"Rome"},{front:"Spain",back:"Madrid"},{front:"United Kingdom",back:"London"},{front:"Japan",back:"Tokyo"},{front:"China",back:"Beijing"},{front:"Australia",back:"Canberra"},{front:"Brazil",back:"BrasÃ­lia"},{front:"Canada",back:"Ottawa"}]}];console.log("Loading example decks...");const{user:n}=f.getState(),o=n?.id||"local-user";for(const e of s){const r=await t().createDeck({userId:o,title:e.title,description:e.description,cardCount:0,isPublic:!1,settings:h,category:e.category,tags:[e.category]});for(const a of e.cards)await t().addCard(r.id,createNewCard(a.front,a.back,{type:"basic"},[]))}console.log("Example decks loaded successfully"),e({isLoading:!1})}catch(r){throw e({error:"Failed to load example decks",isLoading:!1}),r}},clearError:()=>e({error:null}),setLoading:t=>e({isLoading:t}),removeDuplicateCards:async r=>{try{const a=t().cards[r]||[];if(0===a.length)return 0;const s=new Map;let n=0;for(const e of a){const t=`${e.frontContent.trim().toLowerCase()}|${e.backContent.trim().toLowerCase()}`;s.has(t)?(n++,console.log(`Removing duplicate card: ${e.frontContent}`)):s.set(t,e)}const o=Array.from(s.values());return n>0&&(e(e=>({cards:{...e.cards,[r]:o},decks:e.decks.map(e=>e.id===r?{...e,cardCount:o.length,updatedAt:(new Date).toISOString()}:e)})),console.log(`Removed ${n} duplicate cards from deck. ${o.length} unique cards remaining.`)),n}catch(a){throw console.error("Failed to remove duplicate cards:",a),a}},setImportProgress:(t,r)=>e({importProgress:t,importStatus:r}),resetImportProgress:()=>e({importProgress:0,importStatus:null}),hydrateFromIndexedDB:async()=>{const r=t();if(!r.hydrated){e({isLoading:!0});try{const t=await a.decks.list(),s={};for(const e of t){const t=(await a.cards.listByDeck(e.deckId)).map(e=>{const t=(new Date).toISOString(),r=new Date(e.createdAt).toISOString?.()??t,a=e.dueAt?Math.floor(e.dueAt/864e5):Math.floor(Date.now()/864e5);return{id:e.cardId,deckId:e.deckId,frontContent:String(e.fields?.front??""),backContent:String(e.fields?.back??""),cardType:{type:"basic"},mediaRefs:[],easeFactor:"number"==typeof e.ease?e.ease/100:2.5,intervalDays:e.interval??0,nextReview:e.dueAt?new Date(e.dueAt).toISOString():t,createdAt:r,reviewCount:0,lapseCount:e.lapses??0,state:e.state??"new",queue:0,due:a,ivl:e.interval??0,factor:"number"==typeof e.ease?e.ease:250,reps:0,lapses:e.lapses??0,left:0,learningStep:0,graduationInterval:0,easyInterval:0,totalStudyTime:0,averageAnswerTime:0,flags:0,originalDue:0,originalDeck:e.deckId,xpAwarded:0,difficultyRating:0}});s[e.deckId]=t}const n=r.currentUserId||f.getState().user?.id||"local-user",o=[];for(const e of t){const t=e.meta??{},r=t.userId??n;if(!t.userId&&r){const s={...t,userId:r};a.decks.get(e.deckId).then(t=>{if(t)return a.decks.update(e.deckId,{meta:s})}).catch(t=>{t.message?.includes("Deck not found")||console.warn("[deckStore] Failed to migrate userId for deck",e.deckId,t)})}o.push({id:e.deckId,userId:r,title:e.name,description:e.description??"",cardCount:s[e.deckId]?.length??e.cardCount??0,isPublic:t.isPublic??!1,settings:t.settings??{...h},advancedSettings:t.advancedSettings,createdAt:new Date(e.createdAt).toISOString(),updatedAt:new Date(e.updatedAt).toISOString(),tags:t.tags??[],category:t.category??void 0})}e({decks:o,cards:s,hydrated:!0,isLoading:!1,error:null})}catch(s){console.warn("[deckStore] hydrateFromIndexedDB failed",s),e({hydrated:!0,isLoading:!1,error:"Failed to load local data"})}}},startStudySession:(t,r)=>{const a=r.map(e=>e.id);e({currentStudySession:{deckId:t,currentCardIndex:0,studyCards:r,studyCardIds:a,sessionStats:{total:r.length,correct:0,incorrect:0},startedAt:(new Date).toISOString()}})},updateStudySession:(t,r)=>{e(e=>({currentStudySession:e.currentStudySession?{...e.currentStudySession,currentCardIndex:t,sessionStats:r}:null}))},clearStudySession:()=>{e({currentStudySession:null})},getStudySession:e=>{const r=t();return r.currentStudySession?.deckId===e?r.currentStudySession:null},resetAllStudyData:()=>{e(e=>{const t={};for(const[r,a]of Object.entries(e.cards))t[r]=a.map(e=>({...e,easeFactor:2.5,intervalDays:0,nextReview:(new Date).toISOString(),reviewCount:0,lapseCount:0}));return{cards:t,currentStudySession:null}})},setCurrentUser:t=>{e({currentUserId:t})},getUserDecks:()=>{const e=t();return e.currentUserId?e.decks.filter(t=>t.userId===e.currentUserId):[]}}),{name:"deck-storage",partialize:e=>{const{cards:t,currentStudySession:r,...a}=e;return{...a,currentStudySession:r?{deckId:r.deckId,currentCardIndex:r.currentCardIndex,studyCardIds:r.studyCardIds,sessionStats:r.sessionStats,startedAt:r.startedAt}:null}}})),useCurrentCard=()=>{const e=S(),t=e.currentStudySession;if(!t||!t.studyCardIds||0===t.studyCardIds.length)return null;const r=t.studyCardIds[t.currentCardIndex];if(!r)return null;return(e.cards[t.deckId]||[]).find(e=>e.id===r)||null},convertPocketbaseUser=async e=>{const t=e;n.log("[POCKETBASE]","START - convertPocketbaseUser",{userId:t?.id,email:t?.email,username:t?.username});try{const e=String(t?.id??""),r=String(t?.email??""),a=r&&r.includes("@")?r.split("@")[0]:"User",s={id:e,email:r||"unknown@example.com",username:String(t?.username??a??"User"),level:Number(t?.level??1),totalXp:Number(t?.total_xp??0),coins:Number(t?.coins??100),gems:Number(t?.gems??10),createdAt:String(t?.created??(new Date).toISOString()),lastActive:String(t?.last_active??(new Date).toISOString()),preferences:t?.preferences??{theme:"system",language:"en",notifications:!0,soundEffects:!0,dailyGoal:50,timezone:"UTC"}};return n.log("[POCKETBASE]","END - convertPocketbaseUser",s),s}catch(r){n.error("[POCKETBASE]","Error in convertPocketbaseUser",{error:r,stack:r instanceof Error?r.stack:void 0,userId:t?.id});const e=String(t?.id??""),a=String(t?.email??"unknown@example.com"),s=a&&a.includes("@")?a.split("@")[0]:"User",o={id:e,email:a,username:String(t?.username??s??"User"),level:1,totalXp:0,coins:100,gems:10,createdAt:String(t?.created??(new Date).toISOString()),lastActive:(new Date).toISOString(),preferences:{theme:"system",language:"en",notifications:!0,soundEffects:!0,dailyGoal:50,timezone:"UTC"}};return n.log("[POCKETBASE]","END - convertPocketbaseUser (fallback)",o),o}},f=e()((e,t)=>({user:null,session:null,isAuthenticated:!1,isLoading:!1,error:null,signUp:async(t,r,a)=>{e({isLoading:!0,error:null}),n.info("[AUTH_STORE]","signUp - forcing local profile creation (server optional)");const s=await i();await c({displayName:a});const o={id:s.deviceUserId,email:t||"local@device",username:a||s.displayName||"You",level:1,totalXp:0,coins:0,gems:0,createdAt:new Date(s.createdAt).toISOString(),lastActive:(new Date).toISOString(),preferences:{theme:"system",language:"en",notifications:!0,soundEffects:!0,dailyGoal:50,timezone:"UTC"}};e({user:o,session:null,isAuthenticated:!0,isLoading:!1,error:null})},signIn:async(t,r)=>{e({isLoading:!0,error:null}),n.info("[AUTH_STORE]","signIn - forcing local auth (server optional)");const a=await i(),s={id:a.deviceUserId,email:"local@device",username:a.displayName||"You",level:1,totalXp:0,coins:0,gems:0,createdAt:new Date(a.createdAt).toISOString(),lastActive:(new Date).toISOString(),preferences:{theme:"system",language:"en",notifications:!0,soundEffects:!0,dailyGoal:50,timezone:"UTC"}};e({user:s,session:null,isAuthenticated:!0,isLoading:!1,error:null}),S.getState().setCurrentUser(s.id)},signOut:async()=>{n.log("[POCKETBASE]","START - signOut");try{n.log("[POCKETBASE]","Calling PocketBase authStore.clear"),r.authStore.clear(),n.log("[POCKETBASE]","Clearing auth state"),e({user:null,session:null,isAuthenticated:!1,error:null}),S.getState().setCurrentUser(null),n.log("[POCKETBASE]","END - signOut (success)")}catch(t){n.error("[POCKETBASE]","SignOut error",{error:t,stack:t instanceof Error?t.stack:void 0}),e({error:t instanceof Error?t.message:"Logout failed"})}},resetPassword:async t=>{n.log("[POCKETBASE]","START - resetPassword",{email:t}),e({isLoading:!0,error:null});try{await r.collection("users").requestPasswordReset(t),e({isLoading:!1,error:null}),n.log("[POCKETBASE]","END - resetPassword (success)")}catch(a){n.error("[POCKETBASE]","Reset password error",{error:a,stack:a instanceof Error?a.stack:void 0});let t="Password reset failed";a instanceof Error&&(t=a.message.includes("Invalid email")?"Please enter a valid email address.":a.message.includes("not found")?"No account found with this email address.":a.message),e({error:t,isLoading:!1})}},updatePassword:async a=>{n.log("[POCKETBASE]","START - updatePassword",{passwordLength:a.length});const s=t();n.log("[POCKETBASE]","Current auth state",{hasUser:!!s.user,hasSession:!!s.session,isAuthenticated:s.isAuthenticated}),e({isLoading:!0,error:null});try{if(!a||a.length<6)throw new Error("Password must be at least 6 characters long.");if(!s.user?.id)throw new Error("No authenticated user found");n.log("[POCKETBASE]","Calling pb.collection.update"),await r.collection("users").update(s.user.id,{password:a,passwordConfirm:a}),n.log("[POCKETBASE]","Password update successful"),e({isLoading:!1,error:null}),n.log("[POCKETBASE]","END - updatePassword (success)")}catch(o){const t=o instanceof Error?o.message:"An unknown error occurred during password update.";throw n.error("[POCKETBASE]","UpdatePassword failed",{error:t,errorType:o?.constructor?.name,stack:o instanceof Error?o.stack:void 0}),e({isLoading:!1,error:t}),new Error(t)}},updateProfile:async a=>{const{user:s}=t();if(n.log("[POCKETBASE]","START - updateProfile",{userId:s?.id,updates:Object.keys(a)}),s)try{const t={username:a.username,level:a.level,total_xp:a.totalXp,coins:a.coins,gems:a.gems,preferences:a.preferences,last_active:(new Date).toISOString()};n.log("[POCKETBASE]","Updating profile in database",t),await r.collection("users").update(s.id,t),n.log("[POCKETBASE]","Updating local user state"),e({user:{...s,...a}}),n.log("[POCKETBASE]","END - updateProfile (success)")}catch(o){n.error("[POCKETBASE]","Profile update error",{error:o,stack:o instanceof Error?o.stack:void 0}),e({error:o instanceof Error?o.message:"Profile update failed"})}else n.warn("[POCKETBASE]","No user found for profile update")},clearError:()=>{n.log("[POCKETBASE]","Clearing error state"),e({error:null})},initializeAuth:async()=>{n.log("[POCKETBASE]","START - initializeAuth");try{if(r.authStore.isValid&&r.authStore.model){n.log("[POCKETBASE]","Valid auth store found, converting user",{userId:r.authStore.model.id,email:r.authStore.model.email});const t=await convertPocketbaseUser(r.authStore.model);n.log("[POCKETBASE]","Setting authenticated state from initialization"),e({user:t,session:{record:r.authStore.model,token:r.authStore.token},isAuthenticated:!0})}else{n.info("[AUTH_STORE]","No remote session. Bootstrapping local profile.");const t=await i(),r={id:t.deviceUserId,email:"local@device",username:t.displayName||"You",level:1,totalXp:0,coins:0,gems:0,createdAt:new Date(t.createdAt).toISOString(),lastActive:(new Date).toISOString(),preferences:{theme:"system",language:"en",notifications:!0,soundEffects:!0,dailyGoal:50,timezone:"UTC"}};e({user:r,session:null,isAuthenticated:!0}),S.getState().setCurrentUser(r.id),n.log("[AUTH_STORE]","Local profile initialized",{deviceUserId:t.deviceUserId})}n.log("[POCKETBASE]","END - initializeAuth")}catch(t){n.error("[POCKETBASE]","Auth initialization error",{error:t,stack:t instanceof Error?t.stack:void 0}),e({user:null,session:null,isAuthenticated:!1})}},connectOnline:async(e,t)=>{const r=f.getState(),a=r.user?.id;if(!a)throw n.warn("[AUTH_STORE]","connectOnline called without local user"),new Error("No local user");await u({deviceUserId:a,provider:e,serverUserId:t.serverUserId,accessToken:t.accessToken,refreshToken:t.refreshToken,scopes:t.scopes}),n.info("[AUTH_STORE]","Online account linked",{provider:e})},disconnectOnline:async e=>{const t=f.getState(),r=t.user?.id;r&&(await l(r,e),n.info("[AUTH_STORE]","Online account unlinked",{provider:e}))},isOnlineLinked:async e=>{const t=f.getState(),r=t.user?.id;return!!r&&d(r,e)},login:async(t,r)=>{n.info("[AUTH_STORE]","Login - forcing local auth (server optional)");const a=await i(),s={id:a.deviceUserId,email:"local@device",username:a.displayName||"You",level:1,totalXp:0,coins:0,gems:0,createdAt:new Date(a.createdAt).toISOString(),lastActive:(new Date).toISOString(),preferences:{theme:"system",language:"en",notifications:!0,soundEffects:!0,dailyGoal:50,timezone:"UTC"}};e({user:s,session:null,isAuthenticated:!0,isLoading:!1,error:null})},register:async(t,r,a)=>{n.info("[AUTH_STORE]","Register - forcing local profile creation (server optional)");const s=await i();await c({displayName:r});const o={id:s.deviceUserId,email:t||"local@device",username:r||s.displayName||"You",level:1,totalXp:0,coins:0,gems:0,createdAt:new Date(s.createdAt).toISOString(),lastActive:(new Date).toISOString(),preferences:{theme:"system",language:"en",notifications:!0,soundEffects:!0,dailyGoal:50,timezone:"UTC"}};e({user:o,session:null,isAuthenticated:!0,isLoading:!1,error:null}),S.getState().setCurrentUser(o.id)},logout:()=>{const{signOut:e}=t();e()},updateUser:r=>{const{user:a}=t();a&&e({user:{...a,...r}})}}));r.authStore.onChange((e,t)=>{n.info("[POCKETBASE]","Auth state change detected",{hasToken:!!e,hasRecord:!!t,userId:t?.id,timestamp:(new Date).toISOString()}),e&&t?(n.log("[POCKETBASE]","Processing auth state change - user logged in"),convertPocketbaseUser(t).then(r=>{n.log("[POCKETBASE]","Updating auth store for logged in user"),f.setState({user:r,session:{record:t,token:e},isAuthenticated:!0}),S.getState().setCurrentUser(r.id)}).catch(e=>{n.error("[POCKETBASE]","Failed to convert user during auth change",{error:e,userId:t.id})})):(n.log("[POCKETBASE]","Processing auth state change - user logged out"),f.setState({user:null,session:null,isAuthenticated:!1}))});const k=e()(t((e,t)=>({theme:"system",systemTheme:"light",setTheme:r=>{e({theme:r});const{systemTheme:a}=t();"dark"===("system"===r?a:r)?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")},toggleTheme:()=>{const{theme:e}=t(),r="light"===e?"dark":"light";t().setTheme(r)},initializeTheme:()=>{const r=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";e({systemTheme:r}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",r=>{const a=r.matches?"dark":"light";e({systemTheme:a});const{theme:s}=t();"system"===s&&("dark"===a?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"))});const{theme:a}=t();"dark"===("system"===a?r:a)?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}}),{name:"theme-storage",partialize:e=>({theme:e.theme})})),w=[{id:"1",name:"First Steps",description:"Complete your first study session",icon:"ðŸŽ¯",category:"study_milestones",requirements:[{type:"sessions_completed",value:1,operator:"gte"}],xpReward:50,coinReward:10,isSecret:!1,rarity:"common"},{id:"2",name:"Streak Master",description:"Maintain a 7-day study streak",icon:"ðŸ”¥",category:"streaks",requirements:[{type:"current_streak",value:7,operator:"gte"}],xpReward:200,coinReward:50,isSecret:!1,rarity:"rare"},{id:"3",name:"Perfect Score",description:"Get 100% accuracy in a 20+ card session",icon:"ðŸ’¯",category:"accuracy",requirements:[{type:"session_accuracy",value:100,operator:"eq"},{type:"session_cards",value:20,operator:"gte"}],xpReward:150,coinReward:30,isSecret:!1,rarity:"rare"},{id:"4",name:"Speed Demon",description:"Complete 50 cards in under 10 minutes",icon:"âš¡",category:"special",requirements:[{type:"cards_in_session",value:50,operator:"gte"},{type:"session_time",value:600,operator:"lte"}],xpReward:300,coinReward:75,isSecret:!1,rarity:"epic"},{id:"5",name:"Scholar",description:"Study 1000 cards total",icon:"ðŸ“š",category:"study_milestones",requirements:[{type:"total_cards",value:1e3,operator:"gte"}],xpReward:500,coinReward:100,isSecret:!1,rarity:"epic"},{id:"6",name:"Legend",description:"Reach level 20",icon:"ðŸ‘‘",category:"special",requirements:[{type:"user_level",value:20,operator:"gte"}],xpReward:1e3,coinReward:500,isSecret:!1,rarity:"legendary"}],y=[{id:"1",title:"Daily Grind",description:"Study 25 cards today",type:"daily",requirements:[{type:"cards_studied_today",target:25,description:"Study 25 cards"}],rewards:[{type:"xp",amount:50},{type:"coins",amount:10}],startDate:(new Date).toISOString(),endDate:new Date(Date.now()+864e5).toISOString(),isActive:!0,participantCount:1247},{id:"2",title:"Weekly Warrior",description:"Complete 200 cards this week",type:"weekly",requirements:[{type:"cards_studied_week",target:200,description:"Study 200 cards this week"}],rewards:[{type:"xp",amount:200},{type:"coins",amount:50},{type:"gems",amount:5}],startDate:new Date(Date.now()-2592e5).toISOString(),endDate:new Date(Date.now()+3456e5).toISOString(),isActive:!0,participantCount:892},{id:"3",title:"Accuracy Master",description:"Maintain 90%+ accuracy for 5 sessions",type:"weekly",requirements:[{type:"accuracy_sessions",target:5,description:"Complete 5 sessions with 90%+ accuracy"}],rewards:[{type:"xp",amount:300},{type:"coins",amount:75},{type:"badge",itemId:"accuracy_master"}],startDate:new Date(Date.now()-1728e5).toISOString(),endDate:new Date(Date.now()+432e6).toISOString(),isActive:!0,participantCount:456}],I={xp_weekly:{id:"xp_weekly",type:"xp",period:"weekly",entries:[{userId:"1",username:"DemoUser",score:2500,rank:1,change:0},{userId:"2",username:"StudyMaster",score:2350,rank:2,change:1},{userId:"3",username:"FlashcardPro",score:2200,rank:3,change:-1},{userId:"4",username:"LearnFast",score:2100,rank:4,change:2},{userId:"5",username:"MemoryKing",score:2050,rank:5,change:-1},{userId:"6",username:"QuizWhiz",score:1980,rank:6,change:0},{userId:"7",username:"CardShark",score:1920,rank:7,change:3},{userId:"8",username:"BrainBoost",score:1850,rank:8,change:-2},{userId:"9",username:"StudyBuddy",score:1800,rank:9,change:1},{userId:"10",username:"FlashGenius",score:1750,rank:10,change:-1}],updatedAt:(new Date).toISOString()},streak_all_time:{id:"streak_all_time",type:"streak",period:"all_time",entries:[{userId:"2",username:"StudyMaster",score:45,rank:1,change:0},{userId:"3",username:"FlashcardPro",score:38,rank:2,change:0},{userId:"4",username:"LearnFast",score:32,rank:3,change:1},{userId:"1",username:"DemoUser",score:28,rank:4,change:-1},{userId:"5",username:"MemoryKing",score:25,rank:5,change:0},{userId:"6",username:"QuizWhiz",score:22,rank:6,change:2},{userId:"7",username:"CardShark",score:20,rank:7,change:-1},{userId:"8",username:"BrainBoost",score:18,rank:8,change:-1},{userId:"9",username:"StudyBuddy",score:15,rank:9,change:0},{userId:"10",username:"FlashGenius",score:12,rank:10,change:0}],updatedAt:(new Date).toISOString()}},calculateLevel=e=>Math.floor(Math.sqrt(e/100))+1,calculateXPToNextLevel=e=>100*Math.pow(e,2),getInitialUserStats=()=>({totalCards:0,cardsStudiedToday:0,cardsStudiedThisWeek:0,cardsStudiedThisMonth:0,averageAccuracy:0,totalStudyTime:0,studyTimeToday:0,studyTimeThisWeek:0,decksCreated:0,decksCompleted:0,longestStreak:0,currentStreak:0,gold:0,diamonds:0,level:1,xp:0,xpToNextLevel:100}),getDemoUserStats=()=>({totalCards:1250,cardsStudiedToday:45,cardsStudiedThisWeek:180,cardsStudiedThisMonth:720,averageAccuracy:87.5,totalStudyTime:2400,studyTimeToday:35,studyTimeThisWeek:240,decksCreated:8,decksCompleted:3,longestStreak:28,currentStreak:12,gold:100,diamonds:10,level:8,xp:6400,xpToNextLevel:8100}),C=e()(t((e,t)=>({userStats:getInitialUserStats(),isFirstTimeUser:!0,isInitialized:!1,achievements:w,userAchievements:[],userStreak:null,activeChallenges:y,userChallengeParticipations:[],leaderboards:I,updateUserStats:t=>{e(e=>{const r={...e.userStats,...t};return void 0!==t.xp&&(r.level=calculateLevel(r.xp),r.xpToNextLevel=calculateXPToNextLevel(r.level)),{userStats:r,isFirstTimeUser:!1,isInitialized:!0}})},addUserAchievement:r=>{const{userAchievements:a}=t();a.find(e=>e.achievementId===r)||e(e=>({userAchievements:[...e.userAchievements,{id:Date.now().toString(),userId:"1",achievementId:r,earnedAt:(new Date).toISOString()}]}))},updateStreak:t=>{e(e=>({userStreak:e.userStreak?{...e.userStreak,...t}:null}))},joinChallenge:r=>{const{userChallengeParticipations:a}=t();a.find(e=>e.challengeId===r)||e(e=>({userChallengeParticipations:[...e.userChallengeParticipations,{id:Date.now().toString(),userId:"1",challengeId:r,progress:{},completed:!1,joinedAt:(new Date).toISOString(),milestoneProgress:{},weeklyProgress:[],currentStreak:0,bestWeek:0}]}))},updateChallengeProgress:(t,r)=>{e(e=>({userChallengeParticipations:e.userChallengeParticipations.map(e=>e.challengeId===t?{...e,progress:{...e.progress,...r}}:e)}))},claimChallengeReward:r=>{const{activeChallenges:a,userChallengeParticipations:s}=t(),n=a.find(e=>e.id===r),o=s.find(e=>e.challengeId===r);if(n&&o&&o.completed){let t=0,a=0;n.rewards.forEach(e=>{"xp"===e.type&&e.amount?t+=e.amount:"coins"===e.type&&e.amount&&(a+=e.amount)}),e(e=>({userStats:{...e.userStats,totalCards:e.userStats.totalCards+t/10},userChallengeParticipations:e.userChallengeParticipations.filter(e=>e.challengeId!==r)}))}},initializeMockData:()=>{e({userStats:getDemoUserStats(),achievements:w,activeChallenges:y,leaderboards:I,userAchievements:[{id:"1",userId:"1",achievementId:"1",earnedAt:new Date(Date.now()-864e6).toISOString()},{id:"2",userId:"1",achievementId:"2",earnedAt:new Date(Date.now()-432e6).toISOString()}],userStreak:{id:"1",userId:"1",currentStreak:12,longestStreak:28,lastStudyDate:(new Date).toISOString(),freezeCount:2,createdAt:new Date(Date.now()-2592e6).toISOString()},userChallengeParticipations:[{id:"1",userId:"1",challengeId:"1",progress:{cards_studied_today:45},completed:!0,joinedAt:(new Date).toISOString(),completedAt:(new Date).toISOString(),milestoneProgress:{milestone_1:!0},weeklyProgress:[],currentStreak:5,bestWeek:1},{id:"2",userId:"1",challengeId:"2",progress:{cards_studied_week:180},completed:!1,joinedAt:new Date(Date.now()-2592e5).toISOString(),milestoneProgress:{milestone_1:!0,milestone_2:!1},weeklyProgress:[{week:1,startDate:new Date(Date.now()-6048e5).toISOString(),endDate:(new Date).toISOString(),progress:{cards_studied_week:180},completed:!0,completedAt:(new Date).toISOString(),storyUnlocked:!0}],currentStreak:3,bestWeek:1}],isFirstTimeUser:!1,isInitialized:!0})},initializeNewUser:()=>{e({userStats:getInitialUserStats(),userAchievements:[],userStreak:null,userChallengeParticipations:[],isFirstTimeUser:!1,isInitialized:!0})},resetAllUserData:()=>{e({userStats:getInitialUserStats(),userAchievements:[],userStreak:null,userChallengeParticipations:[],isFirstTimeUser:!0,isInitialized:!0})},addCurrency:(t,r)=>{e(e=>({userStats:{...e.userStats,gold:e.userStats.gold+t,diamonds:e.userStats.diamonds+r}}))},spendCurrency:(r,a)=>{const{userStats:s}=t();return s.gold>=r&&s.diamonds>=a&&(e(e=>({userStats:{...e.userStats,gold:e.userStats.gold-r,diamonds:e.userStats.diamonds-a}})),!0)},initializeUserData:(r=!1)=>{t().isInitialized||e(r?{userStats:getDemoUserStats(),achievements:w,activeChallenges:y,leaderboards:I,userAchievements:[{id:"1",userId:"1",achievementId:"1",earnedAt:new Date(Date.now()-864e6).toISOString()},{id:"2",userId:"1",achievementId:"2",earnedAt:new Date(Date.now()-432e6).toISOString()}],userStreak:{id:"1",userId:"1",currentStreak:12,longestStreak:28,lastStudyDate:(new Date).toISOString(),freezeCount:2,createdAt:new Date(Date.now()-2592e6).toISOString()},userChallengeParticipations:[{id:"1",userId:"1",challengeId:"1",progress:{cards_studied_today:45},completed:!0,joinedAt:(new Date).toISOString(),completedAt:(new Date).toISOString()},{id:"2",userId:"1",challengeId:"2",progress:{cards_studied_week:180},completed:!1,joinedAt:new Date(Date.now()-2592e5).toISOString()}],isFirstTimeUser:!1,isInitialized:!0}:{userStats:getInitialUserStats(),userAchievements:[],userStreak:null,userChallengeParticipations:[],isFirstTimeUser:!1,isInitialized:!0})},updateMilestoneProgress:(t,r,a)=>{e(e=>({userChallengeParticipations:e.userChallengeParticipations.map(e=>e.challengeId===t?{...e,milestoneProgress:{...e.milestoneProgress,[r]:a}}:e)}))},updateWeeklyProgress:(t,r)=>{e(e=>({userChallengeParticipations:e.userChallengeParticipations.map(e=>e.challengeId===t?{...e,weeklyProgress:e.weeklyProgress?[...e.weeklyProgress.filter(e=>e.week!==r.week),r]:[r]}:e)}))},updateChallengeStreak:(t,r)=>{e(e=>({userChallengeParticipations:e.userChallengeParticipations.map(e=>e.challengeId===t?{...e,currentStreak:r}:e)}))},unlockStoryChapter:(t,r)=>{e(e=>({userChallengeParticipations:e.userChallengeParticipations.map(e=>e.challengeId===t?{...e,weeklyProgress:e.weeklyProgress?.map(e=>e.week===r?{...e,storyUnlocked:!0}:e)||[]}:e)}))},claimMilestoneReward:(r,a)=>{const{activeChallenges:s}=t();s.find(e=>e.id===r)&&e(e=>({userChallengeParticipations:e.userChallengeParticipations.map(e=>e.challengeId===r?{...e,milestoneProgress:{...e.milestoneProgress,[`${a}_claimed`]:!0}}:e)}))},contributeToCommunityGoal:(t,r)=>{console.log(`Contributing ${r} to community goal ${t}`),e(e=>({userStats:{...e.userStats}}))},awardStudyXP:(t,r)=>{let a=t;a+=r;const s=10*Math.floor(r/10);a+=s,a>0&&e(e=>{const n=e.userStats.xp+a,o=calculateLevel(n),i=calculateXPToNextLevel(o);return console.log(`ðŸŽ‰ XP Awarded: +${a} XP (${t} cards, ${r} correct, ${s} milestone bonus)`),console.log(`ðŸ“Š Total XP: ${e.userStats.xp} â†’ ${n} (Level ${e.userStats.level} â†’ ${o})`),{userStats:{...e.userStats,xp:n,level:o,xpToNextLevel:i,totalCards:e.userStats.totalCards+t,cardsStudiedToday:e.userStats.cardsStudiedToday+t}}})}}),{name:"gamification-storage",partialize:e=>({userStats:e.userStats,userAchievements:e.userAchievements,userStreak:e.userStreak,userChallengeParticipations:e.userChallengeParticipations,isFirstTimeUser:e.isFirstTimeUser,isInitialized:e.isInitialized})}));export{k as a,f as b,S as c,useCurrentCard as d,createNewCard as e,C as u};
//# sourceMappingURL=stores-sGyTT1ft.js.map
