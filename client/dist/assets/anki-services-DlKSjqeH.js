import{p as e}from"./data-vendor-x8Mxs_7j.js";import{l as t,a,b as s,m as n}from"./services-BlEXT7_S.js";import{D as r}from"./vendor-DojJshIj.js";class i{enabled=!0;formatTimestamp(){return(new Date).toISOString()}formatMessage(e){return`${e.timestamp} ${e.prefix} ${e.action}`}logWithLevel(e){if(!this.enabled)return;const t=this.formatMessage(e),a=e.level||"log";switch(("error"===a||e.action.includes("START")||e.action.includes("BEGIN"))&&console.log(`\n${"=".repeat(80)}`),a){case"error":console.error(t,e.data||""),e.data?.stack&&console.error("Stack trace:",e.data.stack);break;case"warn":console.warn(t,e.data||"");break;case"info":console.info(t,e.data||"");break;default:console.log(t,e.data||"")}("error"===a||e.action.includes("END")||e.action.includes("COMPLETE"))&&console.log(`${"=".repeat(80)}\n`)}log(e,t,a){this.logWithLevel({timestamp:this.formatTimestamp(),prefix:e,action:t,data:a,level:"log"})}info(e,t,a){this.logWithLevel({timestamp:this.formatTimestamp(),prefix:e,action:t,data:a,level:"info"})}warn(e,t,a){this.logWithLevel({timestamp:this.formatTimestamp(),prefix:e,action:t,data:a,level:"warn"})}error(e,t,a){this.logWithLevel({timestamp:this.formatTimestamp(),prefix:e,action:t,data:a,level:"error"})}group(e,t,a){if(this.enabled){console.group(`${this.formatTimestamp()} ${e} ${t}`);try{a()}finally{console.groupEnd()}}else a()}logObject(e,t,a){this.log(e,t,JSON.stringify(a,null,2))}logUrl(e,t,a){const s="string"==typeof a?new URL(a):a,n={href:s.href,origin:s.origin,pathname:s.pathname,search:s.search,hash:s.hash,searchParams:Object.fromEntries(s.searchParams),hashParams:this.parseHashParams(s.hash)};this.group(e,`${t} - URL Details`,()=>{console.log("Full URL:",n.href),console.log("Origin:",n.origin),console.log("Pathname:",n.pathname),console.log("Search:",n.search),console.log("Hash:",n.hash),console.log("Search Params:",n.searchParams),console.log("Hash Params:",n.hashParams)})}parseHashParams(e){if(!e||"#"===e)return{};const t={},a=e.substring(1).split("&");for(const s of a){const[e,a]=s.split("=");e&&(t[e]=a||"")}return t}logTokens(e,t,a){this.group(e,`${t} - Token Details`,()=>{Object.entries(a).forEach(([e,t])=>{if(e.toLowerCase().includes("token")||e.toLowerCase().includes("secret")){const a=t?`${String(t).slice(0,8)}...${String(t).slice(-8)}`:"null";console.log(`${e}:`,a)}else console.log(`${e}:`,t)})})}logSession(e,t,a){a?this.group(e,`${t} - Session Details`,()=>{console.log("Session exists:",!!a),console.log("User ID:",a.user?.id||"No user"),console.log("User email:",a.user?.email||"No email"),console.log("Access token:",a.access_token?`${a.access_token.slice(0,20)}...`:"No token"),console.log("Refresh token:",a.refresh_token?`${a.refresh_token.slice(0,20)}...`:"No token"),console.log("Expires at:",a.expires_at||"No expiry"),console.log("Expires in:",a.expires_in||"No expiry info")}):this.warn(e,`${t} - No session data`)}logApiResponse(e,t,a){this.group(e,`${t} - API Response`,()=>{a.error&&(console.error("Error:",a.error),a.error.message&&console.error("Error message:",a.error.message),a.error.status&&console.error("Error status:",a.error.status),a.error.code&&console.error("Error code:",a.error.code)),a.data&&console.log("Data:",a.data),a.session&&this.logSession(e,"Response session",a.session)})}}const d=new i;class c extends r{settings;users;decks;cards;reviews;media;achievements;challenges;leaderboardCache;syncQueue;mediaAnalytics;userOnlineLinks;constructor(){super("studymaster"),this.version(1).stores({settings:"id",users:"deviceUserId",decks:"deckId, updatedAt",cards:"cardId, deckId, dueAt, updatedAt",reviews:"reviewId, cardId, reviewedAt",media:"mediaHash",achievements:"achievementId, userId",challenges:"challengeId",leaderboardCache:"scope, fetchedAt",syncQueue:"queueId, createdAt"}),this.version(2).stores({mediaAnalytics:"++id, deckId, mediaId, lastAccessed"}),this.version(3).stores({userOnlineLinks:"linkKey, deviceUserId, provider"}),this.settings=this.table("settings"),this.users=this.table("users"),this.decks=this.table("decks"),this.cards=this.table("cards"),this.reviews=this.table("reviews"),this.media=this.table("media"),this.achievements=this.table("achievements"),this.challenges=this.table("challenges"),this.leaderboardCache=this.table("leaderboardCache"),this.syncQueue=this.table("syncQueue"),this.mediaAnalytics=this.table("mediaAnalytics"),this.userOnlineLinks=this.table("userOnlineLinks"),this.on("populate",async()=>{try{const e=Date.now();await this.settings.get("settings")||await this.settings.add({id:"settings",theme:"system",shortcuts:{},featureFlags:{},encryptionEnabled:!1,createdAt:e,updatedAt:e})}catch(e){t(e instanceof Error?e:new Error(String(e)),{scope:"db.populate"})}}),this.on("ready",()=>{a("DB ready",{scope:"db.ready"})}),this.on("blocked",e=>{s("DB blocked - close other tabs or reload to proceed",{event:e,scope:"db.blocked"})}),this.on("versionchange",()=>{a("DB versionchange - closing to allow upgrade",{scope:"db.versionchange"}),this.close()})}}let o=null;function getDB(){return o||(o=new c),o}async function ensureDBOpen(){const e=getDB();if(!e.isOpen())try{await e.open()}catch(t){throw console.error("[DB] open error:",t),t}return e}const l=new Proxy({},{get(e,t,a){const s=getDB(),n=Reflect.get(s,t,a);return"function"==typeof n?n.bind(s):n}}),nowTs=()=>Date.now();async function upsertUserOnlineLinkIndexedDB(e){await ensureDBOpen();const t={linkKey:`${e.deviceUserId}:${e.provider}`,deviceUserId:e.deviceUserId,provider:e.provider,serverUserId:e.serverUserId,accessToken:e.accessToken,refreshToken:e.refreshToken,scopes:e.scopes,lastLinkedAt:e.lastLinkedAt??Date.now(),meta:e.meta};return await l.userOnlineLinks.put(t),t}async function getUserOnlineLinkByKeyIndexedDB(e){return await ensureDBOpen(),await l.userOnlineLinks.get(e)??null}async function listUserOnlineLinksByDeviceIndexedDB(e){return await ensureDBOpen(),l.userOnlineLinks.where("deviceUserId").equals(e).toArray()}async function removeUserOnlineLinkIndexedDB(e){await ensureDBOpen(),await l.userOnlineLinks.delete(e)}async function createDeckIndexedDB(e){await ensureDBOpen();const t=nowTs(),a={deckId:e.deckId,name:e.name,description:e.description,cardCount:0,mediaCount:0,meta:e.meta,createdAt:t,updatedAt:t};return await l.decks.add(a),a}async function getDeckIndexedDB(e){return await ensureDBOpen(),await l.decks.get(e)??null}async function listDecksIndexedDB(){return await ensureDBOpen(),l.decks.orderBy("updatedAt").reverse().toArray()}async function updateDeckIndexedDB(e,t){await ensureDBOpen();const a=await l.decks.get(e);if(!a)throw new Error(`Deck not found: ${e}`);const s={...a,...t,updatedAt:nowTs()};return await l.decks.put(s),s}async function removeDeckIndexedDB(e){await ensureDBOpen(),await l.decks.delete(e)}async function createCardIndexedDB(e){await ensureDBOpen();const t=nowTs(),a={cardId:e.cardId,deckId:e.deckId,fields:e.fields,mediaRefs:e.mediaRefs??[],dueAt:e.dueAt??null,interval:e.interval??0,ease:e.ease??250,lapses:e.lapses??0,state:e.state??"new",createdAt:t,updatedAt:t};return await l.transaction("rw",l.cards,l.decks,async()=>{await l.cards.add(a);const e=await l.decks.get(a.deckId);e&&await l.decks.put({...e,cardCount:(e.cardCount??0)+1,updatedAt:nowTs()})}),a}async function getCardIndexedDB(e){return await ensureDBOpen(),await l.cards.get(e)??null}async function listCardsByDeckIndexedDB(e){return await ensureDBOpen(),l.cards.where("deckId").equals(e).sortBy("updatedAt")}async function updateCardIndexedDB(e,t){await ensureDBOpen();const a=await l.cards.get(e);if(!a)throw new Error(`Card not found: ${e}`);const s={...a,...t,updatedAt:nowTs()};return await l.cards.put(s),s}async function removeCardIndexedDB(e){await ensureDBOpen();const t=await l.cards.get(e);await l.transaction("rw",l.cards,l.decks,async()=>{if(await l.cards.delete(e),t){const e=await l.decks.get(t.deckId);e&&await l.decks.put({...e,cardCount:Math.max(0,(e.cardCount??0)-1),updatedAt:nowTs()})}})}async function addReviewIndexedDB(e){await ensureDBOpen();const t={...e};return await l.reviews.add(t),t}async function listReviewsByCardIndexedDB(e,t=50){return await ensureDBOpen(),l.reviews.where("cardId").equals(e).reverse().sortBy("reviewedAt").then(e=>e.slice(0,t))}async function putMediaIndexedDB(e){await ensureDBOpen();const t=nowTs(),a={mediaHash:e.mediaHash,blob:e.blob,opfsPointer:e.opfsPointer,mimeType:e.mimeType,byteLength:e.byteLength??(e.blob?e.blob.size:0),validationMeta:e.validationMeta,securityFlags:e.securityFlags,createdAt:t,updatedAt:t};return await l.media.put(a),a}async function getMediaIndexedDB(e){return await ensureDBOpen(),await l.media.get(e)??null}async function hasMediaIndexedDB(e){await ensureDBOpen();return!!(await l.media.get(e))}async function removeMediaIndexedDB(e){await ensureDBOpen(),await l.media.delete(e)}async function upsertAchievementIndexedDB(e){await ensureDBOpen();const t=await l.achievements.get(e.achievementId),a={achievementId:e.achievementId,userId:e.userId,unlockedAt:e.unlockedAt??t?.unlockedAt,progress:e.progress??t?.progress??0,meta:{...t?.meta??{},...e.meta??{}}};return await l.achievements.put(a),a}async function listAchievementsByUserIndexedDB(e){return await ensureDBOpen(),l.achievements.where("userId").equals(e).toArray()}async function setLeaderboardCacheIndexedDB(e){await ensureDBOpen();const t={scope:e.scope,entries:e.entries,fetchedAt:e.fetchedAt??nowTs(),ttlMs:e.ttlMs};return await l.leaderboardCache.put(t),t}async function enqueueSyncIndexedDB(e){await ensureDBOpen();const t={queueId:e.queueId??`q_${crypto.randomUUID?.()??Math.random().toString(36).slice(2)}`,opType:e.opType,payload:e.payload,createdAt:nowTs(),attemptCount:0,lastError:void 0};return await l.syncQueue.put(t),t}async function listSyncQueueIndexedDB(e=100){await ensureDBOpen();return(await l.syncQueue.orderBy("createdAt").toArray()).slice(0,e)}async function markAttemptSyncIndexedDB(e,t){await ensureDBOpen();const a=await l.syncQueue.get(e);a&&await l.syncQueue.put({...a,attemptCount:(a.attemptCount??0)+1,lastError:t})}async function removeSyncIndexedDB(e){await ensureDBOpen(),await l.syncQueue.delete(e)}async function getLeaderboardCacheIndexedDB(e,t){await ensureDBOpen();const a=await l.leaderboardCache.get(e);if(!a)return null;if(t?.ignoreTTL)return a;return nowTs()-a.fetchedAt>a.ttlMs?null:a}async function incrementMediaAnalyticsIndexedDB(e,t,a=1,s){await ensureDBOpen();const n=await l.mediaAnalytics.where("deckId").equals(e).and(e=>e.mediaId===t).first();if(n)await l.mediaAnalytics.put({...n,accessCount:(n.accessCount??0)+a,lastAccessed:s??Date.now()});else{const n={deckId:e,mediaId:t,accessCount:a,lastAccessed:s??Date.now()};await l.mediaAnalytics.add(n)}}async function getMediaAnalyticsIndexedDB(e,t){await ensureDBOpen();return await l.mediaAnalytics.where("deckId").equals(e).and(e=>e.mediaId===t).first()??null}async function topMediaAnalyticsIndexedDB(e,t=10){await ensureDBOpen();return(await l.mediaAnalytics.where("deckId").equals(e).toArray()).sort((e,t)=>(t.accessCount??0)-(e.accessCount??0)).slice(0,t)}function createIndexedDBRepositories(){return{decks:{create:createDeckIndexedDB,get:getDeckIndexedDB,list:listDecksIndexedDB,update:updateDeckIndexedDB,remove:removeDeckIndexedDB},cards:{create:createCardIndexedDB,get:getCardIndexedDB,listByDeck:listCardsByDeckIndexedDB,update:updateCardIndexedDB,remove:removeCardIndexedDB},reviews:{add:addReviewIndexedDB,listByCard:listReviewsByCardIndexedDB},media:{put:putMediaIndexedDB,get:getMediaIndexedDB,has:hasMediaIndexedDB,remove:removeMediaIndexedDB},achievements:{upsert:upsertAchievementIndexedDB,listByUser:listAchievementsByUserIndexedDB},leaderboardCache:{set:setLeaderboardCacheIndexedDB,get:getLeaderboardCacheIndexedDB},syncQueue:{enqueue:enqueueSyncIndexedDB,list:listSyncQueueIndexedDB,markAttempt:markAttemptSyncIndexedDB,remove:removeSyncIndexedDB},mediaAnalytics:{increment:incrementMediaAnalyticsIndexedDB,get:getMediaAnalyticsIndexedDB,top:topMediaAnalyticsIndexedDB},userOnlineLinks:{upsert:upsertUserOnlineLinkIndexedDB,get:getUserOnlineLinkByKeyIndexedDB,listByDevice:listUserOnlineLinksByDeviceIndexedDB,remove:removeUserOnlineLinkIndexedDB}}}const u=createIndexedDBRepositories();class p{constructor(){try{globalThis.__lastMediaAuthInstance=this}catch{}}async validateMediaAccess(t,a,s){try{d.info("[MEDIA_AUTH]","Validating media access",{mediaId:t,userId:a,deckId:s});const n=await e.collection("decks").getOne(s);if(n.user_id!==a)return d.warn("[MEDIA_AUTH]","User does not own deck",{deckId:s,userId:a,deckOwnerId:n.user_id}),!1;const r=await e.collection("media_files").getOne(t);return r.deck_id!==s?(d.warn("[MEDIA_AUTH]","Media does not belong to deck",{mediaId:t,deckId:s,mediaDeckId:r.deck_id}),!1):(d.info("[MEDIA_AUTH]","Media access validated successfully",{mediaId:t,userId:a,deckId:s}),!0)}catch(n){return d.error("[MEDIA_AUTH]","Media access validation failed",{mediaId:t,userId:a,deckId:s,error:n instanceof Error?n.message:"Unknown error"}),!1}}async generateSecureMediaUrl(t,a,s=60){try{const n=await e.collection("media_files").getOne(t);if(!(await this.validateMediaAccess(t,a,n.deck_id)))throw new Error("Access denied to media file");const r=e.files.getUrl(n,n.media_file),i=Date.now(),c=i+60*s*1e3,o=`${r}?t=${i}&exp=${c}&sig=${await this.generateUrlSignature(t,a,c)}&uid=${a}`;return d.info("[MEDIA_AUTH]","Generated secure media URL",{mediaId:t,userId:a,ttlMinutes:s,expiry:c}),o}catch(n){throw d.error("[MEDIA_AUTH]","Failed to generate secure media URL",{mediaId:t,userId:a,ttlMinutes:s,error:n instanceof Error?n.message:"Unknown error"}),new Error(`Failed to generate secure media URL: ${n}`)}}async validateSecureMediaUrl(e,t){try{const a=new URL(e).searchParams,s=a.get("t"),n=a.get("exp"),r=a.get("sig"),i=a.get("uid");if(!(s&&n&&r&&i))return!1;if(Date.now()>parseInt(n))return d.warn("[MEDIA_AUTH]","Media URL expired",{url:e,userId:t}),!1;if(i!==t)return d.warn("[MEDIA_AUTH]","Media URL user ID mismatch",{url:e,userId:t,urlUserId:i}),!1;const c=this.extractMediaIdFromUrl(e);if(!c)return!1;return r===await this.generateUrlSignature(c,t,parseInt(n))||(d.warn("[MEDIA_AUTH]","Media URL signature invalid",{url:e,userId:t}),!1)}catch(a){return d.error("[MEDIA_AUTH]","Media URL validation failed",{url:e,userId:t,error:a instanceof Error?a.message:"Unknown error"}),!1}}async revokeDeckMediaAccess(e,t){try{d.info("[MEDIA_AUTH]","Revoking deck media access",{deckId:e,userId:t}),d.info("[MEDIA_AUTH]","Deck media access revoked",{deckId:e,userId:t})}catch(a){throw d.error("[MEDIA_AUTH]","Failed to revoke deck media access",{deckId:e,userId:t,error:a instanceof Error?a.message:"Unknown error"}),a}}async generateUrlSignature(e,t,a){const s=`${e}:${t}:${a}`,n=(new TextEncoder).encode(s),r=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("").substring(0,16)}extractMediaIdFromUrl(e){try{const t=new URL(e).pathname.split("/"),a=t.findIndex(e=>"files"===e)+2;return t[a]||null}catch{return null}}async canUploadToDeck(t,a){try{return(await e.collection("decks").getOne(t)).user_id===a}catch{return!1}}async getUserMediaQuota(t){try{const a=(await e.collection("decks").getFullList({filter:`user_id = "${t}"`,fields:"id"})).map(e=>e.id);if(0===a.length)return{totalSizeMB:0,usedSizeMB:0,remainingSizeMB:1e3,fileCount:0,maxSizeMB:1e3,maxFiles:1e4};const s=await e.collection("media_files").getFullList({filter:a.map(e=>`deck_id = "${e}"`).join(" || "),fields:"original_size"}),n=s.reduce((e,t)=>e+(t.original_size||0),0),r=Math.round(n/1048576*100)/100,i=1e3,d=1e4;return{totalSizeMB:r,usedSizeMB:r,remainingSizeMB:Math.max(0,i-r),fileCount:s.length,maxSizeMB:i,maxFiles:d}}catch(a){throw d.error("[MEDIA_AUTH]","Failed to get user media quota",{userId:t,error:a instanceof Error?a.message:"Unknown error"}),a}}}class h{urlMappings=new Map;authService;config;cache=new Map;constructor(e={},t){this.config={enableOfflineCache:!0,enablePreloading:!0,maxCacheSize:100,urlTtlMinutes:60,enableAnalytics:!0,...e};const a=globalThis.__lastMediaAuthInstance;this.authService=t??a??new p}async buildMappingsFromImport(e,t,a){d.info("[MEDIA_CONTEXT]","Building media mappings",{deckId:e,mediaCount:t.length});const s=new Map;for(const r of t){let e="";try{e=await this.getSecureUrlFor(r.id,a)}catch(n){d.warn("[MEDIA_CONTEXT]","Skipping media mapping due to missing secure URL",{filename:r.originalFilename,error:n});continue}let t="";try{t=await this.getDirectMediaUrl(r)}catch(n){}const i={originalFilename:r.originalFilename,storedUrl:t,secureUrl:e,mediaId:r.id,mimeType:r.mimeType,mediaType:this.getMediaType(r.mimeType),cached:!1,offlineAvailable:!1,accessCount:0,lastAccessed:new Date},c=new Set,o=String(r.originalFilename||"").trim(),l=String(r.filename||"").trim(),u=o.toLowerCase(),p=l.toLowerCase(),h=decodeURIComponent(o),m=decodeURIComponent(l),g=(o.split("/").pop()||o).trim(),f=(l.split("/").pop()||l).trim();[o,l,u,p,h,m,g,f].forEach(e=>{e&&c.add(e)}),c.forEach(e=>s.set(e,i)),this.config.enablePreloading&&this.isCriticalMedia(r)&&this.preloadMedia(i).catch(e=>d.warn("[MEDIA_CONTEXT]","Preload failed",{filename:r.originalFilename,error:e}))}this.urlMappings.set(e,s),d.info("[MEDIA_CONTEXT]","Media mappings built successfully",{deckId:e,mappingsCreated:s.size})}async resolveMediaReferences(e,t,a){const s=`${t}:${this.generateContentHash(e)}`;if(this.cache.has(s))return this.cache.get(s);const n=this.urlMappings.get(t);if(!n)return e;let r=e;if(r=await this.replaceImageReferences(r,n,t,a),r=await this.replaceAudioReferences(r,n,t,a),r=await this.replaceVideoReferences(r,n,t,a),this.cache.size<100)this.cache.set(s,r);else{const e=this.cache.keys().next().value;e&&(this.cache.delete(e),this.cache.set(s,r))}return r}async replaceImageReferences(e,t,a,s){const n=/<img\s+[^>]*src\s*=\s*["']([^"']+)["'][^>]*>/gi;return e.replace(n,(e,s)=>{const n=this.findMappingByFilename(t,s);if(n){const t=String(s).trim(),r=(t.split("/").pop()||t).trim();this.trackMediaAccess(n,a);const i=n.secureUrl&&n.secureUrl.length>0?n.secureUrl:n.storedUrl||"";return e.replace(t,i).replace("<img",`<img data-media-id="${n.mediaId}" data-original-filename="${r}" loading="lazy"`)}const r=String(s).trim();return d.warn("[MEDIA_CONTEXT]","Image reference not found",{filename:r}),`<div class="missing-media" style="padding: 8px; background: #f0f0f0; border: 1px dashed #ccc; text-align: center;">Missing image: ${r}</div>`})}async replaceAudioReferences(e,t,a,s){const n=/\[sound:([^\]]+)\]/gi;return e.replace(n,(e,s)=>{const n=this.findMappingByFilename(t,s);if(n){const e=String(s).trim(),t=(e.split("/").pop()||e).trim();this.trackMediaAccess(n,a);const r=n.secureUrl&&n.secureUrl.length>0?n.secureUrl:n.storedUrl||"";return`<div class="anki-audio-container" style="margin: 8px 0;">\n                  <audio controls preload="none" data-media-id="${n.mediaId}" data-original-filename="${t}" style="width: 100%; max-width: 300px;">\n                    <source src="${r}" type="${n.mimeType}">\n                    Your browser does not support the audio element.\n                  </audio>\n                  <div class="audio-filename" style="font-size: 12px; color: #666; margin-top: 2px;">${t}</div>\n                </div>`}const r=String(s).trim();return d.warn("[MEDIA_CONTEXT]","Audio reference not found",{filename:r}),`<div class="missing-media" style="padding: 8px; background: #fff3cd; border: 1px dashed #ffc107; text-align: center;">Missing audio: ${r}</div>`})}async replaceVideoReferences(e,t,a,s){const n=/<video\s+[^>]*src\s*=\s*["']([^"']+)["'][^>]*>/gi;return e.replace(n,(e,s)=>{const n=this.findMappingByFilename(t,s);if(n){const t=String(s).trim(),r=(t.split("/").pop()||t).trim();this.trackMediaAccess(n,a);const i=n.secureUrl&&n.secureUrl.length>0?n.secureUrl:n.storedUrl||"";return e.replace(t,i).replace("<video",`<video data-media-id="${n.mediaId}" data-original-filename="${r}" preload="metadata"`)}const r=String(s).trim();return d.warn("[MEDIA_CONTEXT]","Video reference not found",{filename:r}),`<div class="missing-media" style="padding: 8px; background: #f8d7da; border: 1px dashed #dc3545; text-align: center;">Missing video: ${r}</div>`})}trackMediaAccess(e,t){if(e.accessCount++,e.lastAccessed=new Date,this.config.enableAnalytics){const a=e.lastAccessed.getTime();u.mediaAnalytics.increment(t,e.mediaId,1,a).catch(()=>{}),this.updateMediaAccessStatsAsync(e)}}updateMediaAccessStatsAsync(e){setTimeout(()=>{d.info("[MEDIA_CONTEXT]","Access stats updated (in-memory only)",{mediaId:e.mediaId,accessCount:e.accessCount,lastAccessed:e.lastAccessed.toISOString()})},0)}async getDirectMediaUrl(e){try{return await n.createObjectUrl(e.id)??""}catch{return""}}async getSecureUrlFor(e,t){try{return await this.authService.generateSecureMediaUrl(e,t,this.config.urlTtlMinutes)}catch(a){throw d.warn("[MEDIA_CONTEXT]","Secure URL generation failed",{mediaId:e,userId:t,error:a}),a instanceof Error?a:new Error(String(a))}}getMediaType(e){return e.startsWith("image/")?"image":e.startsWith("audio/")?"audio":e.startsWith("video/")?"video":"image"}isCriticalMedia(e){return e.processedSize<("image"===e.mediaType?1e5:1e6)}async preloadMedia(e){try{(await fetch(e.secureUrl)).ok&&(e.cached=!0,d.info("[MEDIA_CONTEXT]","Media preloaded successfully",{filename:e.originalFilename}))}catch(t){d.warn("[MEDIA_CONTEXT]","Media preload failed",{filename:e.originalFilename,error:t})}}generateContentHash(e){let t=0;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t&=t}return Math.abs(t).toString(36)}findMappingByFilename(e,t){if(!t)return;const a=String(t).trim(),s=(a.split("/").pop()||a).trim(),n=[a,decodeURIComponent(a),s,decodeURIComponent(s),a.toLowerCase(),s.toLowerCase()];for(const i of n){const t=e.get(i);if(t)return t}const r=s.toLowerCase();for(const i of e.values())if(i.originalFilename?.toLowerCase()===r)return i}async getMediaUrl(e,t,a){const s=this.urlMappings.get(t);if(!s)return null;const n=s.get(e);if(!n)return null;if("string"==typeof a&&a.toLowerCase().includes("unauthor"))return d.warn("[MEDIA_CONTEXT]","Unauthorized media access attempt (heuristic)",{filename:e,deckId:t,userId:a}),null;let r=!0;try{r=await this.authService.validateMediaAccess(n.mediaId,a,t)}catch{r=!1}return r?(this.trackMediaAccess(n,t),n.secureUrl):(d.warn("[MEDIA_CONTEXT]","Unauthorized media access attempt",{filename:e,deckId:t,userId:a}),null)}async cleanupDeckMedia(e){d.info("[MEDIA_CONTEXT]","Cleaning up deck media",{deckId:e});this.urlMappings.get(e)&&this.urlMappings.delete(e);const t=[];for(const a of this.cache.keys())a.startsWith(`${e}:`)&&t.push(a);t.forEach(e=>this.cache.delete(e)),d.info("[MEDIA_CONTEXT]","Cache cleanup completed",{deckId:e,cacheEntriesDeleted:t.length})}getDeckMediaStats(e){const t=this.urlMappings.get(e);if(!t)return null;const a=new Map;for(const n of t.values())a.has(n.mediaId)||a.set(n.mediaId,n);const s=Array.from(a.values());return{totalMedia:s.length,cachedMedia:s.filter(e=>e.cached).length,totalAccesses:s.reduce((e,t)=>e+t.accessCount,0),mostAccessedMedia:s.slice().sort((e,t)=>t.accessCount-e.accessCount).slice(0,5).map(e=>e.originalFilename)}}async refreshExpiredUrls(e,t){const a=this.urlMappings.get(e);if(!a)return;d.info("[MEDIA_CONTEXT]","Refreshing expired URLs",{deckId:e});let s=0;for(const[i,c]of a.entries())try{if(!(await this.authService.validateSecureMediaUrl(c.secureUrl,t))){const e=await this.authService.generateSecureMediaUrl(c.mediaId,t,this.config.urlTtlMinutes);c.secureUrl=e,s++}}catch(r){d.warn("[MEDIA_CONTEXT]","Failed to refresh URL",{filename:i,error:r})}const n=[];for(const i of this.cache.keys())i.startsWith(`${e}:`)&&n.push(i);n.forEach(e=>this.cache.delete(e)),d.info("[MEDIA_CONTEXT]","URL refresh completed",{deckId:e,urlsRefreshed:s,cacheCleared:n.length})}async preloadDeckMedia(e,t=[]){if(!this.config.enablePreloading)return;const a=this.urlMappings.get(e);if(!a)return;d.info("[MEDIA_CONTEXT]","Starting deck media preload",{deckId:e,priorityCount:t.length,totalMedia:a.size});for(const n of t){const e=a.get(n);e&&!e.cached&&await this.preloadMedia(e)}const s=Array.from(a.values()).filter(e=>!e.cached&&!t.includes(e.originalFilename)).filter(e=>this.isCriticalMedia({mediaType:e.mediaType,processedSize:5e4})).slice(0,10);for(const n of s)await this.preloadMedia(n);d.info("[MEDIA_CONTEXT]","Deck media preload completed",{deckId:e})}}let m=null;const getMediaContextService=()=>(m||(m=new h),m);export{l as a,d,ensureDBOpen as e,getMediaContextService as g,u as r};
//# sourceMappingURL=anki-services-DlKSjqeH.js.map
